<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>镜头5：英雄救美新版 - 代号qin</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        .hidden {
            display: none !important;
        }
        
        body {
            background: #000;
            overflow: hidden;
            font-family: 'Microsoft YaHei', sans-serif;
            user-select: none;
        }
        
        #scene5-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        
        /* 主视频播放器 */
        #main-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            z-index: 1;
        }
        
        /* 背景音乐（循环） */
        #bgm-scene5 {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
        }
        
        /* 阶段指示器 */
        .phase-indicator {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: #FFD700;
            padding: 8px 16px;
            border-radius: 15px;
            font-size: 14px;
            z-index: 100;
            border: 1px solid #FFD700;
            display: none !important; /* 隐藏提示 */
        }
        
        /* 用户交互按钮样式 - 镜头1风格 */
        .action-button {
            position: fixed;
            top: 65%;
            right: 15%;
            transform: translate(50%, -50%);
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.05) 70%, transparent 100%);
            border: 3px solid rgba(255, 255, 255, 0.6);
            z-index: 999999;
            opacity: 0;
            animation: rippleButton 2s infinite;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
            color: rgba(255, 255, 255, 0.9);
            font-size: 16px;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            text-align: center;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        .action-button::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            animation: rippleWave 2s infinite;
            z-index: -1;
        }
        
        .action-button::after {
            content: '';
            position: absolute;
            width: 120%;
            height: 120%;
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: rippleWave 2s infinite 0.5s;
            z-index: -2;
        }
        
        .action-button:hover {
            transform: translate(50%, -50%) scale(1.1);
            background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, rgba(255, 255, 255, 0.1) 70%, transparent 100%);
            border-color: rgba(255, 255, 255, 0.8);
        }
        
        .action-button.show {
            opacity: 0.8;
            animation: rippleButton 2s infinite;
        }
        
        /* 圆形按钮波动动画 */
        @keyframes rippleButton {
            0%, 100% { 
                transform: translate(50%, -50%) scale(1); 
                opacity: 0.8; 
            }
            50% { 
                transform: translate(50%, -50%) scale(1.05); 
                opacity: 1; 
            }
        }
        
        /* 波纹扩散动画 */
        @keyframes rippleWave {
            0% { 
                transform: scale(1); 
                opacity: 0.6; 
            }
            50% { 
                transform: scale(1.3); 
                opacity: 0.3; 
            }
            100% { 
                transform: scale(1.6); 
                opacity: 0; 
            }
        }
        
        /* 居中按钮波动动画 */
        @keyframes rippleButtonCenter {
            0%, 100% { 
                transform: translate(-50%, -50%) scale(1); 
                opacity: 0.8; 
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.05); 
                opacity: 1; 
            }
        }
        
        /* 居中按钮样式 */
        .action-button.center {
            left: 50%;
            right: auto;
            transform: translate(-50%, -50%);
            animation: rippleButtonCenter 2s infinite;
        }
        
        .action-button.center:hover {
            transform: translate(-50%, -50%) scale(1.1);
        }
        
        /* 选择按钮容器 - 透明玻璃效果，水平排列 */
        .choice-container {
            position: absolute;
            top: 60%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 25px 40px;
            border-radius: 20px;
            min-width: 800px;
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.8);
            transition: all 0.5s ease;
            z-index: 100;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .choice-container.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        
        .choice-title {
            color: #FFD700;
            font-size: 22px;
            text-align: center;
            margin-bottom: 25px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        /* 按钮容器 - 水平排列 */
        .choice-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
        }
        
        .choice-button {
            flex: 1;
            max-width: 220px;
            padding: 18px 15px;
            background: linear-gradient(145deg, rgba(74, 144, 226, 0.9), rgba(53, 122, 189, 0.9));
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .choice-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .choice-button:hover:not(.disabled)::before {
            left: 100%;
        }
        
        .choice-button:hover:not(.disabled) {
            background: linear-gradient(145deg, rgba(91, 160, 242, 0.95), rgba(69, 128, 205, 0.95));
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(74, 144, 226, 0.4);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .choice-button.enabled {
            background: linear-gradient(145deg, rgba(39, 174, 96, 0.9), rgba(33, 154, 82, 0.9));
            border-color: rgba(144, 238, 144, 0.4);
        }
        
        .choice-button.enabled:hover {
            background: linear-gradient(145deg, rgba(55, 190, 112, 0.95), rgba(34, 154, 98, 0.95));
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.4);
            border-color: rgba(144, 238, 144, 0.6);
        }
        
        .choice-button.disabled {
            background: linear-gradient(145deg, rgba(127, 140, 141, 0.6), rgba(108, 123, 125, 0.6));
            color: rgba(189, 195, 199, 0.7);
            cursor: not-allowed;
            border-color: rgba(255, 255, 255, 0.1);
        }
        
        .choice-button.disabled:hover {
            transform: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        /* ===== 镜头5震撼转场效果（复用镜头4效果） ===== */
        /* 去掉色彩变化，与阶段自然过渡，柔和但有冲击力 */
        @keyframes awakening-shock {
            /* 蓄力阶段：轻微暗化营造压迫感 */
            0% { 
                transform: scale(0.95) rotate(0deg);
                filter: brightness(0.6) contrast(1.2) blur(2px);
            }
            5% { 
                transform: scale(0.92) rotate(-1deg);
                filter: brightness(0.4) contrast(1.4) blur(3px);
            }
            /* 爆发阶段：瞬间亮化震撼 */
            15% { 
                transform: scale(1.8) rotate(-3deg);
                filter: brightness(3.0) contrast(2.5) blur(0px);
            }
            /* 强冲击阶段，逐渐恢复 */
            30% { 
                transform: scale(1.4) rotate(2deg);
                filter: brightness(2.2) contrast(2.0) blur(0px);
            }
            45% { 
                transform: scale(1.2) rotate(-1deg);
                filter: brightness(1.8) contrast(1.6) blur(0px);
            }
            /* 稳定过渡回到正常 */
            65% { 
                transform: scale(1.1) rotate(0.5deg);
                filter: brightness(1.4) contrast(1.3) blur(0px);
            }
            85% { 
                transform: scale(1.05) rotate(0deg);
                filter: brightness(1.1) contrast(1.1) blur(0px);
            }
            /* 完全恢复正常 */
            100% { 
                transform: scale(1) rotate(0deg);
                filter: brightness(1) contrast(1) blur(0px);
            }
        }

        @keyframes body-shake-awakening {
            /* 轻微蓄力阶段 */
            0% { transform: translateX(0) translateY(0); }
            5% { transform: translateX(-1px) translateY(-1px); }
            10% { transform: translateX(1px) translateY(1px); }
            /* 爆发阶段 - 适中震动 */
            15% { transform: translateX(-4px) translateY(-3px); }
            18% { transform: translateX(4px) translateY(3px); }
            21% { transform: translateX(-3px) translateY(2px); }
            24% { transform: translateX(3px) translateY(-2px); }
            27% { transform: translateX(-2px) translateY(-1px); }
            30% { transform: translateX(2px) translateY(1px); }
            /* 逐渐平息阶段 */
            35% { transform: translateX(-2px) translateY(-1px); }
            40% { transform: translateX(2px) translateY(1px); }
            45% { transform: translateX(-1px) translateY(0px); }
            50% { transform: translateX(1px) translateY(-1px); }
            60% { transform: translateX(-1px) translateY(1px); }
            70% { transform: translateX(0px) translateY(-1px); }
            80% { transform: translateX(0px) translateY(1px); }
            90% { transform: translateX(0px) translateY(0px); }
            100% { transform: translateX(0) translateY(0); }
        }

        /* 觉醒震撼效果类 - 加快速度 */
        .awakening-shock-effect {
            animation: awakening-shock 0.5s ease-out;
        }

        .body-shake-awakening {
            animation: body-shake-awakening 0.5s ease-out;
        }
        
        /* 觉醒冲击波效果 - 柔和扩散 */
        @keyframes awakening-shockwave {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 1;
            }
            50% {
                transform: translate(-50%, -50%) scale(8);
                opacity: 0.6;
            }
            100% {
                transform: translate(-50%, -50%) scale(15);
                opacity: 0;
            }
        }
        
        /* 战斗胜利界面动画 */
        @keyframes victoryFadeIn {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
            60% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.05);
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        /* 发光动画 */
        @keyframes glow {
            0% {
                text-shadow: 
                    0 0 20px rgba(144, 238, 144, 0.8),
                    0 0 40px rgba(144, 238, 144, 0.6),
                    2px 2px 4px rgba(0, 0, 0, 0.8);
            }
            100% {
                text-shadow: 
                    0 0 30px rgba(144, 238, 144, 1),
                    0 0 60px rgba(144, 238, 144, 0.8),
                    2px 2px 4px rgba(0, 0, 0, 0.8);
            }
        }
        
        /* 跳跃动画 */
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }
        
        /* 脉冲动画 */
        @keyframes pulse {
            0% {
                opacity: 0.3;
                transform: scale(1);
            }
            50% {
                opacity: 0.1;
                transform: scale(1.02);
            }
            100% {
                opacity: 0.3;
                transform: scale(1);
            }
        }
        
        /* 浮动动画 */
        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-8px);
            }
        }
        
        /* 手指晃动动画 */
        @keyframes handShake {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-6px) rotate(-10deg); }
            50% { transform: translateY(0) rotate(0deg); }
            75% { transform: translateY(-6px) rotate(10deg); }
        }
        
        /* 水墨绽放动画 */
        @keyframes inkBloom {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.3);
                border-radius: 50%;
                filter: blur(8px);
            }
            30% {
                opacity: 0.6;
                transform: translate(-50%, -50%) scale(0.8);
                border-radius: 70% 30% 60% 40% / 80% 40% 60% 20%;
                filter: blur(4px);
            }
            60% {
                opacity: 0.9;
                transform: translate(-50%, -50%) scale(1.05);
                border-radius: 65% 35% 70% 30% / 85% 25% 75% 15%;
                filter: blur(1px);
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
                border-radius: 65% 35% 70% 30% / 85% 25% 75% 15%;
                filter: blur(0px);
            }
        }
        
        /* 光泽动画 */
        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }
        
        /* 选中按钮外发光动画 */
        @keyframes pulseGlow {
            0% { box-shadow: 0 0 10px rgba(255,255,150,0.6); }
            100% { box-shadow: 0 0 25px rgba(255,255,200,1); }
        }
        
        @keyframes pulseGlowFilter {
            0% { filter: drop-shadow(0 0 8px rgba(255,120,40,0.6)); }
            100% { filter: drop-shadow(0 0 20px rgba(255,180,80,1)); }
        }
        
        /* 响应式媒体查询 */
        @media (max-height: 800px) {
            .victory-message {
                max-height: 90vh !important;
                padding: 25px 35px !important;
                font-size: 14px !important;
            }
            
            .victory-title {
                font-size: 28px !important;
                margin-bottom: 15px !important;
            }
            
            .victory-content {
                margin-bottom: 15px !important;
                font-size: 13px !important;
            }
            
            .victory-rewards {
                margin-bottom: 20px !important;
                padding: 12px !important;
            }
            
            .victory-button {
                padding: 10px 25px !important;
                font-size: 14px !important;
            }
        }
        
        @media (max-width: 600px) {
            .victory-message {
                max-width: 90vw !important;
                min-width: 300px !important;
                padding: 20px 25px !important;
            }
        }
        
        /* 胜利界面强制居中样式 */
        .victory-dialog-centered {
            position: fixed !important;
            top: 50vh !important;
            left: 50vw !important;
            transform: translate(-50%, -50%) !important;
            z-index: 999999 !important;
            margin: 0 !important;
            display: block !important;
        }
        
        /* 控制面板 */
        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 280px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #333;
            border-radius: 8px;
            color: #fff;
            font-size: 12px;
            z-index: 200;
            padding: 15px;
        }
        
        .controls {
            margin-top: 15px;
        }
        
        .control-button {
            display: block;
            width: 100%;
            margin: 5px 0;
            padding: 8px;
            background: #333;
            color: white;
            border: 1px solid #666;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
            transition: background 0.3s;
        }
        
        .control-button:hover {
            background: #555;
        }
        
        .status {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #666;
            font-size: 10px;
            opacity: 0.8;
        }
        
        /* 屏幕抖动动画 */
        @keyframes screenShake {
            0% { transform: translate(0); }
            20% { transform: translate(-5px, 5px); }
            40% { transform: translate(5px, -5px); }
            60% { transform: translate(-5px, 5px); }
            80% { transform: translate(5px, -5px); }
            100% { transform: translate(0); }
        }
        .shake {
            animation: screenShake 0.4s;
        }
        
        @keyframes screenShakeStrong {
            0% { transform: translate(0); }
            20% { transform: translate(-25px, 25px); }
            40% { transform: translate(25px, -25px); }
            60% { transform: translate(-25px, 25px); }
            80% { transform: translate(25px, -25px); }
            100% { transform: translate(0); }
        }
        .shake-strong {
            animation: screenShakeStrong 0.6s;
        }
        .shake-strong-infinite {
            animation: screenShakeStrong 0.6s infinite;
        }
        .shake-infinite {
            animation: screenShake 0.4s infinite;
        }
    </style>
</head>
<body>
    <div id="scene5-container">
        <!-- 主视频播放器 -->
        <video id="main-video" preload="auto"></video>
        
        <!-- 背景音乐（循环） -->
        <audio id="bgm-scene5" loop preload="auto">
            <source src="镜头4/1/S04001.MP3" type="audio/mpeg" />
        </audio>
        
        <!-- 当前阶段指示器 -->
        <div class="phase-indicator" id="phase-indicator">阶段1：发生了什么？</div>
        
        <!-- 用户交互按钮 -->
        <button class="action-button hidden" id="action-button">发生了什么？</button>
        
        <!-- 选择按钮容器 -->
        <div class="choice-container hidden" id="choice-container">
            <div class="choice-title">面对恶霸，你要如何行动？</div>
            <div class="choice-buttons">
                <button class="choice-button enabled" data-choice="fight">
                    💪 打败贵族少年<br><small>（武德>15）</small>
                </button>
                <button class="choice-button disabled" data-choice="escape">
                    🏃‍♂️ 带男孩逃跑<br><small style="color: #e74c3c;">（巧思>15）</small>
                </button>
                <button class="choice-button disabled" data-choice="apologize">
                    🙏 道歉求饶<br><small style="color: #e74c3c;">（文采>15）</small>
                </button>
            </div>
        </div>
        
        <!-- 调试控制面板 -->
        <div class="debug-panel" id="debug-controls">
            <h4 style="margin: 0 0 10px 0; color: #90EE90;">镜头5：英雄救美新版</h4>
            <div>当前阶段: <span id="current-phase">1</span></div>
            <div>状态: <span id="scene-status">准备中</span></div>
            <div>视频: <span id="video-status">未开始</span></div>
            
            <div class="controls">
                <button class="control-button" onclick="scene5.skipToPhase(2)">跳转到阶段2</button>
                <button class="control-button" onclick="scene5.skipToPhase(3)">跳转到阶段3</button>
                <button class="control-button" onclick="scene5.testShockTransition()" style="background: #9b59b6;">💥 测试震撼转场</button>
                <button class="control-button" onclick="scene5.restartScene()">重新开始</button>
                <button class="control-button" onclick="scene5.nextScene()">下一镜头</button>
            </div>
        </div>
    </div>

    <script>
        class Scene5NewController {
            constructor() {
                this.container = document.getElementById('scene5-container');
                this.mainVideo = document.getElementById('main-video');
                this.phaseIndicator = document.getElementById('phase-indicator');
                this.actionButton = document.getElementById('action-button');
                this.choiceContainer = document.getElementById('choice-container');
                
                // 状态显示元素
                this.currentPhaseSpan = document.getElementById('current-phase');
                this.sceneStatus = document.getElementById('scene-status');
                this.videoStatus = document.getElementById('video-status');
                
                // 背景音乐元素
                this.bgm = document.getElementById('bgm-scene5');
                
                // 当前阶段
                this.currentPhase = 1;
                this.choiceMade = false;
                
                // 视频路径配置
                this.videos = {
                    phase1: '镜头5/1/C05001-1.mp4',    // 第一阶段视频（原声）
                    phase2: '镜头5/2/C05002-1.mp4',    // 第二阶段视频
                    phase3Result: '镜头5/3/C05003-2.mp4',  // 选择后的结果视频
                    phase3Final: '镜头5/3/C05003-1.mp4',   // 最终视频
                    phase4: '镜头5/4/C05004-1.mp4'        // 退出后视频
                };
                
                // 镜头6资源
                this.videos6 = {
                    introAudio: '镜头6/1/S06001.MP3',
                    video1: '镜头6/1/C06001.mp4',
                    video2: '镜头6/2/C06002/C06002-1.mp4',
                    video3: '镜头6/3/C06003-1.mp4',
                    video4: '镜头6/4/C06004-1.mp4',
                    video5: '镜头6/5/C06005-1.mp4'
                };
                
                // 镜头6状态
                this.scene6Phase = 0;
                this.pendantClicks = 0;
                this.scene6Audio = null;
                
                // 镜头7资源
                this.videos7 = {
                    video1: '镜头7/1/C07001-1.mp4',
                    video2: '镜头7/2/C07002-1.mp4',
                    video3: '镜头7/3/C07003-1.mp4'
                };

                this.audio7 = {
                    bgm: '镜头7/1/S07001.MP3'
                };

                this.scene7Audio = null;
                this.currentChapter = 5; // 5:scene5,6:scene6,7:scene7
                
                this.init();
            }
            
            async init() {
                console.log('🎬 镜头5：英雄救美新版 - 初始化开始');
                
                try {
                    // 检查是否在iframe中运行，如果是则隐藏控制面板
                    if (window.parent !== window) {
                        const debugControls = document.getElementById('debug-controls');
                        if (debugControls) {
                            debugControls.style.display = 'none';
                            console.log('🖥️ 在iframe中运行，已隐藏调试控制面板');
                        }
                    }
                    
                    // 开始第一阶段
                    await this.startPhase1();
                    
                    // 开始背景音乐
                    try {
                        this.bgm.volume = 0.4;
                        await this.bgm.play();
                        console.log('🎵 背景音乐已播放');
                    } catch(e) {
                        console.warn('⚠️ 背景音乐播放失败，可能需要用户交互', e);
                    }
                    
                    // 添加消息监听器
                    window.addEventListener('message', (e)=>{
                        if(e.data.type==='cleanup-ui'){
                            this.clearAllUI();
                        } else if(e.data.type==='stop-all-audio'){
                            if(this.bgm){this.bgm.pause();}
                            if(this.scene6Audio){this.scene6Audio.pause();}
                            if(this.scene7Audio){this.scene7Audio.pause();}
                            if(this.mainVideo){this.mainVideo.pause();}
                        } else if(e.data.type==='force-start-scene6'){
                            this.startScene6();
                        } else if(e.data.type==='force-start-scene7'){
                            this.startScene7();
                        }
                    });
                    
                    // 添加键盘监听器
                    document.addEventListener('keydown',(e)=>{
                        if((e.key==='`'||e.key==='~'||e.code==='Backquote') && window.parent && window.parent!==window){
                            window.parent.postMessage({type:'toggle-console'}, '*');
                        }
                    });
                    
                } catch (error) {
                    console.error('❌ 初始化失败:', error);
                    this.updateStatus('初始化失败');
                }
            }
            
            async startPhase1() {
                console.log('🎬 开始阶段1：播放C05001-1.mp4');
                this.currentPhase = 1;
                this.updatePhaseDisplay('阶段1：发生了什么？');
                this.updateStatus('播放第一阶段视频');
                this.hideActionButton();
                this.hideChoiceContainer();
                
                // 重置选择状态
                this.choiceMade = false;
                
                // 设置视频源
                this.mainVideo.src = this.videos.phase1;
                this.mainVideo.muted = false; // 保留原声
                this.mainVideo.loop = false;
                this.mainVideo.volume = 1.0;
                
                // 清除所有之前的事件监听器
                this.mainVideo.onended = null;
                this.mainVideo.ontimeupdate = null;
                
                // 监听视频结束事件
                this.mainVideo.onended = () => {
                    console.log('✅ 阶段1视频播放完成，显示"发生了什么？"按钮');
                    this.showWhatHappenedButton();
                };
                
                try {
                    await this.mainVideo.play();
                    this.updateVideoStatus('阶段1播放中');
                    console.log('✅ 阶段1视频开始播放');
                } catch (error) {
                    console.error('❌ 阶段1视频播放失败:', error);
                    this.updateStatus('视频播放失败');
                    this.showManualPlayCover();
                }
            }
            
            showWhatHappenedButton() {
                // 防止重复显示 - 检查是否已经显示
                if (this.actionButton.classList.contains('show')) {
                    console.log('⚠️ 按钮已显示，跳过重复显示');
                    return;
                }
                
                console.log('🔘 显示"发生了什么？"按钮');
                this.actionButton.textContent = '发生了什么？';
                this.actionButton.classList.remove('hidden');
                this.actionButton.classList.add('show');
                
                // 绑定点击事件（防止重复绑定）
                this.actionButton.onclick = () => {
                    console.log('🔘 用户点击"发生了什么？"按钮');
                    this.hideActionButton(); // 立即隐藏按钮
                    this.startPhase2();
                };
            }
            
            async startPhase2() {
                console.log('🎬 开始阶段2：播放C05002-1.mp4');
                this.currentPhase = 2;
                this.updatePhaseDisplay('阶段2：冲突升级');
                this.updateStatus('播放第二阶段视频');
                this.hideActionButton();
                
                // 设置视频源
                this.mainVideo.src = this.videos.phase2;
                this.mainVideo.muted = false; // 保留原声
                this.mainVideo.loop = false;
                this.mainVideo.volume = 1.0;
                
                // 清除所有之前的事件监听器
                this.mainVideo.onended = null;
                this.mainVideo.ontimeupdate = null;
                
                // 监听时间更新，在最后一帧暂停
                this.mainVideo.ontimeupdate = () => {
                    // 当视频接近结束时暂停并显示选择按钮
                    if (this.mainVideo.duration > 0 && 
                        this.mainVideo.currentTime >= this.mainVideo.duration - 0.1) {
                        this.mainVideo.pause();
                        this.mainVideo.ontimeupdate = null; // 移除监听
                        console.log('✅ 阶段2视频暂停在最后一帧，显示选择按钮');
                        this.showChoiceButtons();
                    }
                };
                
                try {
                    await this.mainVideo.play();
                    this.updateVideoStatus('阶段2播放中');
                    console.log('✅ 阶段2视频开始播放');
                } catch (error) {
                    console.error('❌ 阶段2视频播放失败:', error);
                    this.updateStatus('视频播放失败');
                }
            }
            
            showChoiceButtons() {
                if (document.getElementById('choice-overlay')) return;

                this.updatePhaseDisplay('阶段3：选择行动');

                // 创建半透明黑色遮罩
                const overlay = document.createElement('div');
                overlay.id = 'choice-overlay';
                overlay.style.cssText = `
                    position: fixed;top:0;left:0;width:100vw;height:100vh;
                    background: rgba(0,0,0,0.55);z-index:999998;
                    display:flex;flex-direction:column;align-items:center;justify-content:flex-end;
                    gap:15px;padding-bottom:10vh;`
                document.body.appendChild(overlay);

                const choices = ['1','2','3'];
                choices.forEach((id,idx)=>{
                    const img = document.createElement('img');
                    img.src = `镜头5/3/${id}.png`;
                    img.style.cssText = `width:650px;max-width:85vw;height:auto;transition:transform 0.3s;`;

                    if(idx===0){
                        // 第一个按钮发光并可点击
                        img.style.filter='drop-shadow(0 0 14px rgba(255,120,40,0.85))';
                        img.style.animation='pulseGlowFilter 1.5s infinite alternate';
                        img.style.cursor='pointer';
                        img.onmouseenter=()=>img.style.transform='scale(1.05)';
                        img.onmouseleave=()=>img.style.transform='scale(1)';
                        img.onclick=()=>{
                            overlay.remove();
                            this.makeChoice('fight');
                        };
                    } else {
                        // 2、3按钮禁用
                        img.style.cursor='default';
                        img.style.pointerEvents='none';
                        img.style.opacity='0.7';
                    }

                    overlay.appendChild(img);
                });
            }
            
            async makeChoice(choice) {
                if (this.choiceMade) return; // 防止重复选择
                
                this.choiceMade = true;
                console.log(`✅ 用户选择：${choice}`);
                this.updateStatus('播放选择结果');
                
                // 播放选择结果视频
                await this.playChoiceResult();
            }
            
            async playChoiceResult() {
                console.log('🎬 播放选择结果视频：C05003-2.mp4');
                
                // 🎥 预加载下一个视频，避免切换时黑屏
                if (window.videoPreloader) {
                    console.log('🎥 预加载最终视频，避免切换黑屏...');
                    window.videoPreloader.preloadVideo(this.videos.phase3Final);
                }
                
                // 设置视频源
                this.mainVideo.src = this.videos.phase3Result;
                this.mainVideo.muted = false;
                this.mainVideo.loop = false;
                this.mainVideo.volume = 1.0;
                
                // 清除所有之前的事件监听器
                this.mainVideo.onended = null;
                this.mainVideo.ontimeupdate = null;
                
                // 监听视频结束事件
                this.mainVideo.onended = () => {
                    console.log('✅ 选择结果视频播放完成，开始震撼转场');
                    this.startShockTransition();
                };
                
                try {
                    await this.mainVideo.play();
                    this.updateVideoStatus('选择结果播放中');
                    console.log('✅ 选择结果视频开始播放');
                } catch (error) {
                    console.error('❌ 选择结果视频播放失败:', error);
                    this.updateStatus('视频播放失败');
                }
            }
            
            startShockTransition() {
                console.log('💥 开始震撼转场效果');
                this.updateStatus('震撼转场中');
                
                // 使用镜头4风格的震撼转场效果
                this.triggerAwakeningShockEffect(() => {
                    this.playFinalVideo();
                });
            }
            
            triggerAwakeningShockEffect(callback) {
                console.log('💥 触发觉醒震撼转场效果');
                
                // 添加震撼效果到主容器
                this.container.classList.add('awakening-shock-effect');
                document.body.classList.add('body-shake-awakening');
                
                // 创建觉醒闪光效果
                this.createAwakeningFlash();
                
                // 创建冲击波效果
                this.createAwakeningShockwave();
                
                // 设备震动 (如果支持)
                if (navigator.vibrate) {
                    navigator.vibrate([100, 50, 300, 100, 300, 100, 200, 50, 100]);
                }
                
                // 显示震撼效果状态
                this.updateStatus('⚡ 震撼能量爆发中...');
                
                // 移除震撼效果类 - 适配新的0.5s速度
                setTimeout(() => {
                    this.container.classList.remove('awakening-shock-effect');
                    document.body.classList.remove('body-shake-awakening');
                    this.updateStatus('🌟 震撼转场完成');
                    console.log('✅ 震撼转场效果完成');
                    
                    // 执行回调
                    if (callback) {
                        callback();
                    }
                }, 500); // 0.5s
            }
            
            createAwakeningFlash() {
                const flash = document.createElement('div');
                flash.className = 'awakening-flash';
                flash.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100vh;
                    background: radial-gradient(circle, rgba(255,255,255,0.6) 0%, rgba(255,255,255,0.3) 30%, rgba(255,255,255,0.1) 60%, transparent 80%);
                    z-index: 9998;
                    opacity: 0;
                    pointer-events: none;
                    transition: opacity 0.12s ease-out;
                `;
                document.body.appendChild(flash);
                
                // 更柔和的闪光时序，快速亮起然后柔和消退
                setTimeout(() => flash.style.opacity = '1', 75);   // 爆发点亮起
                setTimeout(() => flash.style.opacity = '0.5', 150); // 开始消退
                setTimeout(() => flash.style.opacity = '0.2', 250); // 继续消退
                setTimeout(() => flash.style.opacity = '0', 400);   // 完全消失
                setTimeout(() => flash.remove(), 500);
            }
            
            createAwakeningShockwave() {
                // 创建2层柔和的白色冲击波
                for (let i = 0; i < 2; i++) {
                    setTimeout(() => {
                        const shockwave = document.createElement('div');
                        shockwave.style.cssText = `
                            position: fixed;
                            top: 50%;
                            left: 50%;
                            width: 60px;
                            height: 60px;
                            border: ${2 - i}px solid rgba(255, 255, 255, ${0.4 - i * 0.1});
                            border-radius: 50%;
                            z-index: 9997;
                            animation: awakening-shockwave 0.5s ease-out;
                            animation-delay: ${i * 0.1}s;
                            pointer-events: none;
                            transform: translate(-50%, -50%) scale(0);
                            box-shadow: 0 0 ${15 - i * 5}px rgba(255, 255, 255, ${0.3 - i * 0.1});
                        `;
                        document.body.appendChild(shockwave);
                        
                        setTimeout(() => shockwave.remove(), 600);
                    }, i * 100); // 适中的间隔
                }
            }
            
            async playFinalVideo() {
                console.log('🎬 播放最终视频：C05003-1.mp4');
                this.updatePhaseDisplay('阶段4：故事结束');
                this.updateStatus('播放最终视频');
                
                // 🎥 确保最终视频完全加载后再播放，避免黑屏
                const waitForVideoReady = () => {
                    return new Promise((resolve) => {
                        if (this.mainVideo.readyState >= 3) { // HAVE_FUTURE_DATA
                            console.log('✅ 最终视频已准备就绪');
                            resolve();
                        } else {
                            console.log('⏳ 等待最终视频加载...');
                            const checkReady = () => {
                                if (this.mainVideo.readyState >= 3) {
                                    console.log('✅ 最终视频加载完成');
                                    resolve();
                                } else {
                                    setTimeout(checkReady, 50);
                                }
                            };
                            checkReady();
                        }
                    });
                };
                
                // 设置视频源
                this.mainVideo.src = this.videos.phase3Final;
                this.mainVideo.muted = false;
                this.mainVideo.loop = false;
                this.mainVideo.volume = 1.0;
                
                // 清除之前的监听器
                this.mainVideo.onended = null;
                this.mainVideo.ontimeupdate = null;

                // 使用ended事件，播放完毕后定格最后一帧并提示
                this.mainVideo.onended = () => {
                    // 定格最后一帧
                    this.mainVideo.pause();
                    console.log('⏸️ 最终视频播放结束并定格');
                    this.showExitPrompt();
                };
                
                try {
                    // 等待视频准备就绪
                    await waitForVideoReady();
                    
                    await this.mainVideo.play();
                    this.updateVideoStatus('最终视频播放中');
                    console.log('✅ 最终视频开始播放');
                } catch (error) {
                    console.error('❌ 最终视频播放失败:', error);
                    this.updateStatus('视频播放失败');
                }
            }
            
            completeScene() {
                console.log('✅ 镜头5完成');
                this.updateStatus('镜头完成');
                
                // 不再显示战斗胜利界面（已去掉）
            }
            
            // 工具方法
            cleanupScene() {
                console.log('🧹 清理镜头5场景状态');
                
                // 清除所有视频事件监听器
                if (this.mainVideo) {
                    this.mainVideo.onended = null;
                    this.mainVideo.ontimeupdate = null;
                    this.mainVideo.pause();
                }
                
                // 隐藏所有UI元素
                this.hideActionButton();
                this.hideChoiceContainer();
                
                // 重置状态
                this.currentPhase = 1;
                this.choiceMade = false;
                
                // 移除可能存在的胜利界面
                const victoryMessage = document.querySelector('div[style*="z-index: 99999"]');
                if (victoryMessage) {
                    victoryMessage.remove();
                }
                
                // 停止背景音乐
                if (this.bgm) {
                    this.bgm.pause();
                    this.bgm.currentTime = 0;
                }
            }
            
            updatePhaseDisplay(phaseText) {
                this.phaseIndicator.textContent = phaseText;
                this.currentPhaseSpan.textContent = this.currentPhase;
            }
            
            updateStatus(status) {
                this.sceneStatus.textContent = status;
            }
            
            updateVideoStatus(status) {
                this.videoStatus.textContent = status;
            }
            
            hideActionButton() {
                this.actionButton.classList.add('hidden');
                this.actionButton.classList.remove('show');
                this.actionButton.classList.remove('center');
            }
            
            hideChoiceContainer() {
                this.choiceContainer.classList.remove('show');
                this.choiceContainer.classList.add('hidden');
            }
            
            // 测试和跳转方法
            async skipToPhase(phase) {
                console.log(`⚡ 快速跳转到阶段${phase}`);
                
                switch (phase) {
                    case 2:
                        await this.startPhase2();
                        break;
                    case 3:
                        this.showChoiceButtons();
                        break;
                    default:
                        await this.startPhase1();
                }
            }
            
            testShockTransition() {
                console.log('🧪 测试震撼转场效果');
                this.triggerAwakeningShockEffect();
            }
            
            restartScene() {
                console.log('🔄 重新开始镜头5');
                
                // 清理场景状态
                this.cleanupScene();
                
                // 重新初始化
                this.init();
            }
            
            nextScene() {
                console.log('➡️ 进入镜头6流程');

                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({ type: 'scene5-complete' }, '*');
                    // 在父页面中仍继续播放镜头6
                    this.startScene6();
                } else {
                    this.startScene6();
                }
            }
            
            // 手动播放覆盖层
            showManualPlayCover() {
                if (document.getElementById('manual-play-cover')) return;
                const cover = document.createElement('div');
                cover.id = 'manual-play-cover';
                cover.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100vh;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: #fff;
                    font-size: 18px;
                    z-index: 999999;
                    cursor: pointer;
                `;
                cover.textContent = '点击以继续播放';
                cover.addEventListener('click', async () => {
                    cover.remove();
                    this.mainVideo.muted = false;
                    try {
                        await this.mainVideo.play();
                        this.updateVideoStatus('阶段1播放中');
                        this.updateStatus('播放中');
                    } catch (e) {
                        console.error('❌ 用户点击后仍无法播放:', e);
                        this.updateStatus('播放失败');
                    }
                });
                document.body.appendChild(cover);
            }
            
            showExitPrompt() {
                if (document.getElementById('exit-prompt')) return;
                const prompt = document.createElement('div');
                prompt.id = 'exit-prompt';
                prompt.style.cssText = `
                    position: fixed;top:0;left:0;width:100vw;height:100vh;
                    background: rgba(0,0,0,0.6);
                    display: flex;flex-direction: column;align-items: center;justify-content: flex-end;gap: 12px;padding-bottom:20vh;
                    color: #fff;
                    font-size: 22px;
                    z-index: 999999;
                    cursor: pointer;
                `;
                prompt.innerHTML = `<div style="font-size:48px; animation: handShake 1.2s infinite;">👇</div><div style="font-size:20px;">点击屏幕确认</div>`;
                prompt.addEventListener('click', () => {
                    prompt.remove();
                    this.playPhase4Video();
                });
                document.body.appendChild(prompt);
            }

            async playPhase4Video() {
                console.log('🎬 播放退出后视频：C05004-1.mp4');
                // 黑色淡入遮罩
                const fade = document.createElement('div');
                fade.style.cssText = `
                    position: fixed;top:0;left:0;width:100vw;height:100vh;
                    background:#000;opacity:0;z-index:999998;pointer-events:none;
                    transition:opacity 0.6s;`
                document.body.appendChild(fade);
                requestAnimationFrame(()=>{fade.style.opacity='1'});
                await new Promise(r=>setTimeout(r,600));
                // 切换视频后淡出
                this.updatePhaseDisplay('阶段5：结束转场');
                this.updateStatus('播放结束视频');

                // 设置视频源
                this.mainVideo.src = this.videos.phase4;
                this.mainVideo.muted = false;
                this.mainVideo.loop = false;
                this.mainVideo.volume = 1.0;

                // 播放完结束视频后，显示"跟上他！"按钮
                this.mainVideo.onended = () => {
                    console.log('🏁 结束视频播放完毕，显示跟上他按钮');
                    this.showFollowButton();
                };

                try {
                    await this.mainVideo.play();
                    this.updateVideoStatus('结束视频播放中');
                    // 淡出遮罩
                    fade.style.opacity='0';
                    setTimeout(()=>fade.remove(),600);
                } catch (error) {
                    console.error('❌ 结束视频播放失败:', error);
                    this.updateStatus('播放失败');
                    fade.remove();
                }
            }

            showFollowButton() {
                if (this.actionButton.classList.contains('show')) return;
                this.actionButton.textContent = '跟上他！';
                this.actionButton.classList.add('center');
                this.actionButton.classList.remove('hidden');
                this.actionButton.classList.add('show');
                this.actionButton.onclick = () => {
                    this.hideActionButton();
                    this.nextScene();
                };
            }

            /* ---------------- 镜头6流程 ---------------- */
            startScene6() {
                console.log('🎬 镜头6启动');
                this.currentPhase = 6;
                this.updatePhaseDisplay('镜头6：荒野夜路');
                this.updateStatus('播放环境音');

                // 清理可能遗留的UI
                this.clearAllUI();
                // 停止背景音并清空
                if(this.bgm){
                    this.bgm.pause();
                    this.bgm.currentTime=0;
                    this.bgm.src='';
                }

                // 播放循环背景音
                if (!this.scene6Audio) {
                    this.scene6Audio = new Audio(this.videos6.introAudio);
                    this.scene6Audio.loop = true;
                }
                this.scene6Audio.volume = 0.6;
                this.scene6Audio.play().catch(e=>console.warn('⚠️ 镜头6音频播放失败',e));

                // 播放第一个视频
                this.playScene6Video1();
            }

            playScene6Video1() {
                this.playWithFade(this.videos6.video1, ()=>{
                    console.log('✅ 镜头6-1 播放完毕');
                    this.showContinueWalkButton();
                });

                this.updateVideoStatus('镜头6-1 播放中');
            }

            showContinueWalkButton() {
                this.actionButton.textContent = '继续走';
                this.actionButton.classList.add('center');
                this.actionButton.classList.remove('hidden');
                this.actionButton.classList.add('show');
                this.actionButton.onclick = () => {
                    this.hideActionButton();
                    this.playScene6Video2();
                };
            }

            playScene6Video2() {
                this.playWithFade(this.videos6.video2, ()=>{
                    console.log('✅ 镜头6-2 播放完毕');
                    this.showRemovePendantButton();
                });
                this.updateVideoStatus('镜头6-2 播放中');
            }

            showRemovePendantButton() {
                this.actionButton.textContent = '取下玉佩';
                this.actionButton.classList.add('center');
                this.actionButton.classList.remove('hidden');
                this.actionButton.classList.add('show');
                this.actionButton.onclick = () => {
                    this.hideActionButton();
                    this.playScene6Video3();
                };
            }

            playScene6Video3() {
                this.playWithFade(this.videos6.video3, ()=>{
                    console.log('✅ 镜头6-3 播放完毕');
                    this.showScene6Choices();
                });
                this.updateVideoStatus('镜头6-3 播放中');
            }

            showScene6Choices() {
                if (document.getElementById('scene6-choice-overlay')) return;
                const overlay = document.createElement('div');
                overlay.id = 'scene6-choice-overlay';
                overlay.style.cssText = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.55);z-index:999998;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;gap:15px;padding-bottom:10vh;`;
                document.body.appendChild(overlay);

                const choiceData = [
                    {src:'镜头6/3/1.png', clickable:true, glow:true, value:'brave'},
                    {src:'镜头6/3/2.png', clickable:false, glow:false, value:'hide'}
                ];

                choiceData.forEach(data=>{
                    const img = document.createElement('img');
                    img.src = data.src;
                    img.style.cssText = `width:650px;max-width:85vw;height:auto;margin-bottom:15px;transition:transform 0.3s;`;

                    if(data.glow){
                        img.style.filter='drop-shadow(0 0 14px rgba(255,120,40,0.85))';
                        img.style.animation='pulseGlowFilter 1.5s infinite alternate';
                    }

                    img.onmouseenter=()=>img.style.transform='scale(1.05)';
                    img.onmouseleave=()=>img.style.transform='scale(1)';

                    if(data.clickable){
                        img.style.cursor='pointer';
                        img.onclick=()=>{
                            overlay.remove();
                            console.log('🔘 场景6选择',data.value);
                            this.playScene6Video4();
                        };
                    } else {
                        img.style.cursor='default';
                        img.style.pointerEvents='none';
                        img.style.opacity='0.7';
                    }

                    overlay.appendChild(img);
                });
            }

            playScene6Video4() {
                this.playWithFade(this.videos6.video4, ()=>{
                    console.log('✅ 镜头6-4 播放完毕');
                    this.showTouchPendantButton();
                });
                this.updateVideoStatus('镜头6-4 播放中');
            }

            showTouchPendantButton() {
                this.pendantClicks = 0;
                this.actionButton.textContent = '触摸玉佩（0/3）';
                this.actionButton.classList.add('center');
                this.actionButton.classList.remove('hidden');
                this.actionButton.classList.add('show');
                this.actionButton.onclick = () => {
                    this.handlePendantTouch();
                };
            }

            handlePendantTouch() {
                this.pendantClicks += 1;
                this.actionButton.textContent = `触摸玉佩（${this.pendantClicks}/3）`;
                // 震动/抖动效果
                this.container.classList.add('shake');
                setTimeout(()=>this.container.classList.remove('shake'),400);

                if (this.pendantClicks >= 3) {
                    this.hideActionButton();
                    this.playScene6Video5();
                }
            }

            playScene6Video5() {
                this.playWithFade(this.videos6.video5, ()=>{
                    console.log('🏁 镜头6流程结束');
                    if(window.parent && window.parent!==window){
                        window.parent.postMessage({type:'scene6-complete'}, '*');
                    }
                    this.showScene7Prompt();
                });

                // 取消 any timeupdate shake logic
                this.mainVideo.ontimeupdate = null;

                this.updateVideoStatus('镜头6-5 播放中');
            }

            showScene7Prompt() {
                if(document.getElementById('scene7-start-prompt')) return;
                const prompt = document.createElement('div');
                prompt.id = 'scene7-start-prompt';
                prompt.style.cssText = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.6);display:flex;flex-direction:column;align-items:center;justify-content:flex-end;padding-bottom:20vh;gap:12px;color:#fff;z-index:999999;cursor:pointer;`;
                prompt.innerHTML = `<div style="font-size:48px;animation:handShake 1.2s infinite;">👇</div><div style="font-size:20px;">点击屏幕继续</div>`;
                prompt.onclick = ()=>{
                    prompt.remove();
                    // 停止镜头6背景音
                    if(this.scene6Audio){
                        this.scene6Audio.pause();
                        this.scene6Audio=null;
                    }
                    this.startScene7();
                };
                document.body.appendChild(prompt);
            }

            /* ----------- 镜头7流程 ------------- */
            startScene7(){
                console.log('🎬 启动镜头7');
                this.currentChapter=7;
                this.updatePhaseDisplay('镜头7：未知旅程');
                this.playScene7Video1();
                if(window.parent && window.parent!==window){
                    window.parent.postMessage({type:'scene7-start'}, '*');
                }
            }

            playScene7Video1(){
                this.playWithFade(this.videos7.video1, ()=>{
                    console.log('✅ 镜头7-1 播放完毕');
                    this.showScene7WhatHappenedButton();
                });
                this.updateVideoStatus('镜头7-1 播放中');
            }

            showScene7WhatHappenedButton(){
                this.actionButton.textContent='发生了什么？';
                this.actionButton.classList.add('center');
                this.actionButton.classList.remove('hidden');
                this.actionButton.classList.add('show');
                this.actionButton.onclick=()=>{
                    this.hideActionButton();
                    this.playScene7Video2();
                };
            }

            playScene7Video2(){
                // 若背景音乐未开启，则立即启动
                if(!this.scene7Audio){
                    this.scene7Audio = new Audio(this.audio7.bgm);
                    this.scene7Audio.loop = true;
                    this.scene7Audio.volume = 0.5;
                    this.scene7Audio.play().catch(e=>console.warn('⚠️ 镜头7 BGM 播放失败',e));
                }

                this.playWithFade(this.videos7.video2, ()=>{
                    console.log('✅ 镜头7-2 播放完毕');
                    this.showMeetMasterButton();
                });
                this.updateVideoStatus('镜头7-2 播放中');
            }

            showMeetMasterButton(){
                this.actionButton.textContent='拜见师父';
                this.actionButton.classList.add('center');
                this.actionButton.classList.remove('hidden');
                this.actionButton.classList.add('show');
                this.actionButton.onclick=()=>{
                    this.hideActionButton();
                    this.playScene7Video3();
                };
            }

            playScene7Video3(){
                this.playWithFade(this.videos7.video3, ()=>{
                    console.log('🏁 镜头7流程结束');
                    if(window.parent && window.parent!==window){
                        window.parent.postMessage({type:'scene7-complete'}, '*');
                    }
                });
                this.updateVideoStatus('镜头7-3 播放中');
            }
            /* ----------- 镜头7流程结束 ------------- */

            // 通用带黑幕淡入淡出的视频播放方法
            async playWithFade(src, onEndedCallback){
                await this.crossfadeMainVideo(src, {muted:false,loop:false});
                this.mainVideo.onended=()=>{ if(typeof onEndedCallback==='function') onEndedCallback(); };
            }

            crossfadeMainVideo(newSrc, { muted=false, loop=false, autoplay=true }={}){
                return new Promise((resolve)=>{
                    if(this.mainVideo.src.includes(newSrc)){
                        resolve(this.mainVideo);return;
                    }
                    const nextVideo=document.createElement('video');
                    nextVideo.className=this.mainVideo.className||'';
                    nextVideo.preload='auto';
                    nextVideo.muted=muted;
                    nextVideo.loop=loop;
                    nextVideo.playsInline=true;
                    nextVideo.style.cssText='position:absolute;top:0;left:0;width:100%;height:100%;object-fit:contain;opacity:0;transition:opacity 0.4s ease;z-index:1;';
                    this.container.appendChild(nextVideo);

                    const doPlay=()=>{
                        if(autoplay){nextVideo.play().catch(()=>{});}            
                        requestAnimationFrame(()=>{
                            nextVideo.style.opacity='1';
                            this.mainVideo.style.transition='opacity 0.4s ease';
                            this.mainVideo.style.opacity='0';
                            setTimeout(()=>{
                                try{this.mainVideo.pause();}catch(e){}
                                if(this.mainVideo.parentNode){this.mainVideo.parentNode.removeChild(this.mainVideo);}    
                                this.mainVideo=nextVideo;
                                resolve(nextVideo);
                            },400);
                        });
                    };

                    // 使用预加载器
                    if(window.videoPreloader){
                        const pre=window.videoPreloader.getPreloadedVideo(newSrc);
                        if(pre){nextVideo.src=newSrc;} else {window.videoPreloader.preloadVideo(newSrc).finally(()=>{nextVideo.src=newSrc;});}
                    } else { nextVideo.src=newSrc; }

                    nextVideo.addEventListener('loadeddata',()=>doPlay());
                });
            }

            clearAllUI(){
                this.hideActionButton();
                ['choice-overlay','scene6-choice-overlay','scene7-start-prompt'].forEach(id=>{
                    const el=document.getElementById(id);
                    if(el) el.remove();
                });
            }
        }
        
        // 全局实例
        let scene5;
        
        // 页面加载完成后初始化
        window.addEventListener('DOMContentLoaded', () => {
            scene5 = new Scene5NewController();
        });
        
        // 添加快捷键支持
        document.addEventListener('keydown', (e) => {
            if (!scene5) return;
            
            switch(e.key) {
                case '1':
                    scene5.skipToPhase(1);
                    break;
                case '2':
                    scene5.skipToPhase(2);
                    break;
                case '3':
                    scene5.skipToPhase(3);
                    break;
                case ' ':
                    e.preventDefault();
                    if (scene5.currentPhase === 1 && !scene5.actionButton.classList.contains('hidden')) {
                        scene5.startPhase2();
                    }
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (scene5.currentPhase === 3 && !scene5.choiceMade) {
                        scene5.makeChoice('fight');
                    }
                    break;
                case 'r':
                case 'R':
                    scene5.restartScene();
                    break;
                case 'n':
                case 'N':
                    scene5.nextScene();
                    break;
                case 's':
                case 'S':
                    scene5.testShockTransition();
                    break;
            }
        });
        
        console.log('🎮 镜头5控制：数字键1-3=跳转阶段, 空格=继续, 回车=选择1, S=测试震撼转场, R=重启, N=下一镜头');
    </script>
    
    <!-- 引入视频预加载系统 -->
    <script src="video-preloader.js"></script>
</body>
</html> 