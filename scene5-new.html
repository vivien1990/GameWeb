<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é•œå¤´5ï¼šè‹±é›„æ•‘ç¾æ–°ç‰ˆ - ä»£å·qin</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        .hidden {
            display: none !important;
        }
        
        body {
            background: #000;
            overflow: hidden;
            font-family: 'Microsoft YaHei', sans-serif;
            user-select: none;
        }
        
        #scene5-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        
        /* ä¸»è§†é¢‘æ’­æ”¾å™¨ */
        #main-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            z-index: 1;
        }
        
        /* èƒŒæ™¯éŸ³ä¹ï¼ˆå¾ªç¯ï¼‰ */
        #bgm-scene5 {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
        }
        
        /* é˜¶æ®µæŒ‡ç¤ºå™¨ */
        .phase-indicator {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: #FFD700;
            padding: 8px 16px;
            border-radius: 15px;
            font-size: 14px;
            z-index: 100;
            border: 1px solid #FFD700;
            display: none !important; /* éšè—æç¤º */
        }
        
        /* ç”¨æˆ·äº¤äº’æŒ‰é’®æ ·å¼ - é•œå¤´1é£æ ¼ */
        .action-button {
            position: fixed;
            top: 65%;
            right: 15%;
            transform: translate(50%, -50%);
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.05) 70%, transparent 100%);
            border: 3px solid rgba(255, 255, 255, 0.6);
            z-index: 999999;
            opacity: 0;
            animation: rippleButton 2s infinite;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
            color: rgba(255, 255, 255, 0.9);
            font-size: 16px;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            text-align: center;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        .action-button::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            animation: rippleWave 2s infinite;
            z-index: -1;
        }
        
        .action-button::after {
            content: '';
            position: absolute;
            width: 120%;
            height: 120%;
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: rippleWave 2s infinite 0.5s;
            z-index: -2;
        }
        
        .action-button:hover {
            transform: translate(50%, -50%) scale(1.1);
            background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, rgba(255, 255, 255, 0.1) 70%, transparent 100%);
            border-color: rgba(255, 255, 255, 0.8);
        }
        
        .action-button.show {
            opacity: 0.8;
            animation: rippleButton 2s infinite;
        }
        
        /* åœ†å½¢æŒ‰é’®æ³¢åŠ¨åŠ¨ç”» */
        @keyframes rippleButton {
            0%, 100% { 
                transform: translate(50%, -50%) scale(1); 
                opacity: 0.8; 
            }
            50% { 
                transform: translate(50%, -50%) scale(1.05); 
                opacity: 1; 
            }
        }
        
        /* æ³¢çº¹æ‰©æ•£åŠ¨ç”» */
        @keyframes rippleWave {
            0% { 
                transform: scale(1); 
                opacity: 0.6; 
            }
            50% { 
                transform: scale(1.3); 
                opacity: 0.3; 
            }
            100% { 
                transform: scale(1.6); 
                opacity: 0; 
            }
        }
        
        /* å±…ä¸­æŒ‰é’®æ³¢åŠ¨åŠ¨ç”» */
        @keyframes rippleButtonCenter {
            0%, 100% { 
                transform: translate(-50%, -50%) scale(1); 
                opacity: 0.8; 
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.05); 
                opacity: 1; 
            }
        }
        
        /* å±…ä¸­æŒ‰é’®æ ·å¼ */
        .action-button.center {
            left: 50%;
            right: auto;
            transform: translate(-50%, -50%);
            animation: rippleButtonCenter 2s infinite;
        }
        
        .action-button.center:hover {
            transform: translate(-50%, -50%) scale(1.1);
        }
        
        /* é€‰æ‹©æŒ‰é’®å®¹å™¨ - é€æ˜ç»ç’ƒæ•ˆæœï¼Œæ°´å¹³æ’åˆ— */
        .choice-container {
            position: absolute;
            top: 60%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 25px 40px;
            border-radius: 20px;
            min-width: 800px;
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.8);
            transition: all 0.5s ease;
            z-index: 100;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .choice-container.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        
        .choice-title {
            color: #FFD700;
            font-size: 22px;
            text-align: center;
            margin-bottom: 25px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        /* æŒ‰é’®å®¹å™¨ - æ°´å¹³æ’åˆ— */
        .choice-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
        }
        
        .choice-button {
            flex: 1;
            max-width: 220px;
            padding: 18px 15px;
            background: linear-gradient(145deg, rgba(74, 144, 226, 0.9), rgba(53, 122, 189, 0.9));
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .choice-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .choice-button:hover:not(.disabled)::before {
            left: 100%;
        }
        
        .choice-button:hover:not(.disabled) {
            background: linear-gradient(145deg, rgba(91, 160, 242, 0.95), rgba(69, 128, 205, 0.95));
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(74, 144, 226, 0.4);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .choice-button.enabled {
            background: linear-gradient(145deg, rgba(39, 174, 96, 0.9), rgba(33, 154, 82, 0.9));
            border-color: rgba(144, 238, 144, 0.4);
        }
        
        .choice-button.enabled:hover {
            background: linear-gradient(145deg, rgba(55, 190, 112, 0.95), rgba(34, 154, 98, 0.95));
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.4);
            border-color: rgba(144, 238, 144, 0.6);
        }
        
        .choice-button.disabled {
            background: linear-gradient(145deg, rgba(127, 140, 141, 0.6), rgba(108, 123, 125, 0.6));
            color: rgba(189, 195, 199, 0.7);
            cursor: not-allowed;
            border-color: rgba(255, 255, 255, 0.1);
        }
        
        .choice-button.disabled:hover {
            transform: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        /* ===== é•œå¤´5éœ‡æ’¼è½¬åœºæ•ˆæœï¼ˆå¤ç”¨é•œå¤´4æ•ˆæœï¼‰ ===== */
        /* å»æ‰è‰²å½©å˜åŒ–ï¼Œä¸é˜¶æ®µè‡ªç„¶è¿‡æ¸¡ï¼ŒæŸ”å’Œä½†æœ‰å†²å‡»åŠ› */
        @keyframes awakening-shock {
            /* è“„åŠ›é˜¶æ®µï¼šè½»å¾®æš—åŒ–è¥é€ å‹è¿«æ„Ÿ */
            0% { 
                transform: scale(0.95) rotate(0deg);
                filter: brightness(0.6) contrast(1.2) blur(2px);
            }
            5% { 
                transform: scale(0.92) rotate(-1deg);
                filter: brightness(0.4) contrast(1.4) blur(3px);
            }
            /* çˆ†å‘é˜¶æ®µï¼šç¬é—´äº®åŒ–éœ‡æ’¼ */
            15% { 
                transform: scale(1.8) rotate(-3deg);
                filter: brightness(3.0) contrast(2.5) blur(0px);
            }
            /* å¼ºå†²å‡»é˜¶æ®µï¼Œé€æ¸æ¢å¤ */
            30% { 
                transform: scale(1.4) rotate(2deg);
                filter: brightness(2.2) contrast(2.0) blur(0px);
            }
            45% { 
                transform: scale(1.2) rotate(-1deg);
                filter: brightness(1.8) contrast(1.6) blur(0px);
            }
            /* ç¨³å®šè¿‡æ¸¡å›åˆ°æ­£å¸¸ */
            65% { 
                transform: scale(1.1) rotate(0.5deg);
                filter: brightness(1.4) contrast(1.3) blur(0px);
            }
            85% { 
                transform: scale(1.05) rotate(0deg);
                filter: brightness(1.1) contrast(1.1) blur(0px);
            }
            /* å®Œå…¨æ¢å¤æ­£å¸¸ */
            100% { 
                transform: scale(1) rotate(0deg);
                filter: brightness(1) contrast(1) blur(0px);
            }
        }

        @keyframes body-shake-awakening {
            /* è½»å¾®è“„åŠ›é˜¶æ®µ */
            0% { transform: translateX(0) translateY(0); }
            5% { transform: translateX(-1px) translateY(-1px); }
            10% { transform: translateX(1px) translateY(1px); }
            /* çˆ†å‘é˜¶æ®µ - é€‚ä¸­éœ‡åŠ¨ */
            15% { transform: translateX(-4px) translateY(-3px); }
            18% { transform: translateX(4px) translateY(3px); }
            21% { transform: translateX(-3px) translateY(2px); }
            24% { transform: translateX(3px) translateY(-2px); }
            27% { transform: translateX(-2px) translateY(-1px); }
            30% { transform: translateX(2px) translateY(1px); }
            /* é€æ¸å¹³æ¯é˜¶æ®µ */
            35% { transform: translateX(-2px) translateY(-1px); }
            40% { transform: translateX(2px) translateY(1px); }
            45% { transform: translateX(-1px) translateY(0px); }
            50% { transform: translateX(1px) translateY(-1px); }
            60% { transform: translateX(-1px) translateY(1px); }
            70% { transform: translateX(0px) translateY(-1px); }
            80% { transform: translateX(0px) translateY(1px); }
            90% { transform: translateX(0px) translateY(0px); }
            100% { transform: translateX(0) translateY(0); }
        }

        /* è§‰é†’éœ‡æ’¼æ•ˆæœç±» - åŠ å¿«é€Ÿåº¦ */
        .awakening-shock-effect {
            animation: awakening-shock 0.5s ease-out;
        }

        .body-shake-awakening {
            animation: body-shake-awakening 0.5s ease-out;
        }
        
        /* è§‰é†’å†²å‡»æ³¢æ•ˆæœ - æŸ”å’Œæ‰©æ•£ */
        @keyframes awakening-shockwave {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 1;
            }
            50% {
                transform: translate(-50%, -50%) scale(8);
                opacity: 0.6;
            }
            100% {
                transform: translate(-50%, -50%) scale(15);
                opacity: 0;
            }
        }
        
        /* æˆ˜æ–—èƒœåˆ©ç•Œé¢åŠ¨ç”» */
        @keyframes victoryFadeIn {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
            60% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.05);
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        /* å‘å…‰åŠ¨ç”» */
        @keyframes glow {
            0% {
                text-shadow: 
                    0 0 20px rgba(144, 238, 144, 0.8),
                    0 0 40px rgba(144, 238, 144, 0.6),
                    2px 2px 4px rgba(0, 0, 0, 0.8);
            }
            100% {
                text-shadow: 
                    0 0 30px rgba(144, 238, 144, 1),
                    0 0 60px rgba(144, 238, 144, 0.8),
                    2px 2px 4px rgba(0, 0, 0, 0.8);
            }
        }
        
        /* è·³è·ƒåŠ¨ç”» */
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }
        
        /* è„‰å†²åŠ¨ç”» */
        @keyframes pulse {
            0% {
                opacity: 0.3;
                transform: scale(1);
            }
            50% {
                opacity: 0.1;
                transform: scale(1.02);
            }
            100% {
                opacity: 0.3;
                transform: scale(1);
            }
        }
        
        /* æµ®åŠ¨åŠ¨ç”» */
        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-8px);
            }
        }
        
        /* æ‰‹æŒ‡æ™ƒåŠ¨åŠ¨ç”» */
        @keyframes handShake {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-6px) rotate(-10deg); }
            50% { transform: translateY(0) rotate(0deg); }
            75% { transform: translateY(-6px) rotate(10deg); }
        }
        
        /* æ°´å¢¨ç»½æ”¾åŠ¨ç”» */
        @keyframes inkBloom {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.3);
                border-radius: 50%;
                filter: blur(8px);
            }
            30% {
                opacity: 0.6;
                transform: translate(-50%, -50%) scale(0.8);
                border-radius: 70% 30% 60% 40% / 80% 40% 60% 20%;
                filter: blur(4px);
            }
            60% {
                opacity: 0.9;
                transform: translate(-50%, -50%) scale(1.05);
                border-radius: 65% 35% 70% 30% / 85% 25% 75% 15%;
                filter: blur(1px);
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
                border-radius: 65% 35% 70% 30% / 85% 25% 75% 15%;
                filter: blur(0px);
            }
        }
        
        /* å…‰æ³½åŠ¨ç”» */
        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }
        
        /* é€‰ä¸­æŒ‰é’®å¤–å‘å…‰åŠ¨ç”» */
        @keyframes pulseGlow {
            0% { box-shadow: 0 0 10px rgba(255,255,150,0.6); }
            100% { box-shadow: 0 0 25px rgba(255,255,200,1); }
        }
        
        @keyframes pulseGlowFilter {
            0% { filter: drop-shadow(0 0 8px rgba(255,120,40,0.6)); }
            100% { filter: drop-shadow(0 0 20px rgba(255,180,80,1)); }
        }
        
        /* å“åº”å¼åª’ä½“æŸ¥è¯¢ */
        @media (max-height: 800px) {
            .victory-message {
                max-height: 90vh !important;
                padding: 25px 35px !important;
                font-size: 14px !important;
            }
            
            .victory-title {
                font-size: 28px !important;
                margin-bottom: 15px !important;
            }
            
            .victory-content {
                margin-bottom: 15px !important;
                font-size: 13px !important;
            }
            
            .victory-rewards {
                margin-bottom: 20px !important;
                padding: 12px !important;
            }
            
            .victory-button {
                padding: 10px 25px !important;
                font-size: 14px !important;
            }
        }
        
        @media (max-width: 600px) {
            .victory-message {
                max-width: 90vw !important;
                min-width: 300px !important;
                padding: 20px 25px !important;
            }
        }
        
        /* èƒœåˆ©ç•Œé¢å¼ºåˆ¶å±…ä¸­æ ·å¼ */
        .victory-dialog-centered {
            position: fixed !important;
            top: 50vh !important;
            left: 50vw !important;
            transform: translate(-50%, -50%) !important;
            z-index: 999999 !important;
            margin: 0 !important;
            display: block !important;
        }
        
        /* æ§åˆ¶é¢æ¿ */
        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 280px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #333;
            border-radius: 8px;
            color: #fff;
            font-size: 12px;
            z-index: 200;
            padding: 15px;
        }
        
        .controls {
            margin-top: 15px;
        }
        
        .control-button {
            display: block;
            width: 100%;
            margin: 5px 0;
            padding: 8px;
            background: #333;
            color: white;
            border: 1px solid #666;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
            transition: background 0.3s;
        }
        
        .control-button:hover {
            background: #555;
        }
        
        .status {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #666;
            font-size: 10px;
            opacity: 0.8;
        }
        
        /* å±å¹•æŠ–åŠ¨åŠ¨ç”» */
        @keyframes screenShake {
            0% { transform: translate(0); }
            20% { transform: translate(-5px, 5px); }
            40% { transform: translate(5px, -5px); }
            60% { transform: translate(-5px, 5px); }
            80% { transform: translate(5px, -5px); }
            100% { transform: translate(0); }
        }
        .shake {
            animation: screenShake 0.4s;
        }
        
        @keyframes screenShakeStrong {
            0% { transform: translate(0); }
            20% { transform: translate(-25px, 25px); }
            40% { transform: translate(25px, -25px); }
            60% { transform: translate(-25px, 25px); }
            80% { transform: translate(25px, -25px); }
            100% { transform: translate(0); }
        }
        .shake-strong {
            animation: screenShakeStrong 0.6s;
        }
        .shake-strong-infinite {
            animation: screenShakeStrong 0.6s infinite;
        }
        .shake-infinite {
            animation: screenShake 0.4s infinite;
        }
    </style>
</head>
<body>
    <div id="scene5-container">
        <!-- ä¸»è§†é¢‘æ’­æ”¾å™¨ -->
        <video id="main-video" preload="auto"></video>
        
        <!-- èƒŒæ™¯éŸ³ä¹ï¼ˆå¾ªç¯ï¼‰ -->
        <audio id="bgm-scene5" loop preload="auto">
            <source src="é•œå¤´4/1/S04001.MP3" type="audio/mpeg" />
        </audio>
        
        <!-- å½“å‰é˜¶æ®µæŒ‡ç¤ºå™¨ -->
        <div class="phase-indicator" id="phase-indicator">é˜¶æ®µ1ï¼šå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</div>
        
        <!-- ç”¨æˆ·äº¤äº’æŒ‰é’® -->
        <button class="action-button hidden" id="action-button">å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</button>
        
        <!-- é€‰æ‹©æŒ‰é’®å®¹å™¨ -->
        <div class="choice-container hidden" id="choice-container">
            <div class="choice-title">é¢å¯¹æ¶éœ¸ï¼Œä½ è¦å¦‚ä½•è¡ŒåŠ¨ï¼Ÿ</div>
            <div class="choice-buttons">
                <button class="choice-button enabled" data-choice="fight">
                    ğŸ’ª æ‰“è´¥è´µæ—å°‘å¹´<br><small>ï¼ˆæ­¦å¾·>15ï¼‰</small>
                </button>
                <button class="choice-button disabled" data-choice="escape">
                    ğŸƒâ€â™‚ï¸ å¸¦ç”·å­©é€ƒè·‘<br><small style="color: #e74c3c;">ï¼ˆå·§æ€>15ï¼‰</small>
                </button>
                <button class="choice-button disabled" data-choice="apologize">
                    ğŸ™ é“æ­‰æ±‚é¥¶<br><small style="color: #e74c3c;">ï¼ˆæ–‡é‡‡>15ï¼‰</small>
                </button>
            </div>
        </div>
        
        <!-- è°ƒè¯•æ§åˆ¶é¢æ¿ -->
        <div class="debug-panel" id="debug-controls">
            <h4 style="margin: 0 0 10px 0; color: #90EE90;">é•œå¤´5ï¼šè‹±é›„æ•‘ç¾æ–°ç‰ˆ</h4>
            <div>å½“å‰é˜¶æ®µ: <span id="current-phase">1</span></div>
            <div>çŠ¶æ€: <span id="scene-status">å‡†å¤‡ä¸­</span></div>
            <div>è§†é¢‘: <span id="video-status">æœªå¼€å§‹</span></div>
            
            <div class="controls">
                <button class="control-button" onclick="scene5.skipToPhase(2)">è·³è½¬åˆ°é˜¶æ®µ2</button>
                <button class="control-button" onclick="scene5.skipToPhase(3)">è·³è½¬åˆ°é˜¶æ®µ3</button>
                <button class="control-button" onclick="scene5.testShockTransition()" style="background: #9b59b6;">ğŸ’¥ æµ‹è¯•éœ‡æ’¼è½¬åœº</button>
                <button class="control-button" onclick="scene5.restartScene()">é‡æ–°å¼€å§‹</button>
                <button class="control-button" onclick="scene5.nextScene()">ä¸‹ä¸€é•œå¤´</button>
            </div>
        </div>
    </div>

    <script>
        class Scene5NewController {
            constructor() {
                this.container = document.getElementById('scene5-container');
                this.mainVideo = document.getElementById('main-video');
                this.phaseIndicator = document.getElementById('phase-indicator');
                this.actionButton = document.getElementById('action-button');
                this.choiceContainer = document.getElementById('choice-container');
                
                // çŠ¶æ€æ˜¾ç¤ºå…ƒç´ 
                this.currentPhaseSpan = document.getElementById('current-phase');
                this.sceneStatus = document.getElementById('scene-status');
                this.videoStatus = document.getElementById('video-status');
                
                // èƒŒæ™¯éŸ³ä¹å…ƒç´ 
                this.bgm = document.getElementById('bgm-scene5');
                
                // å½“å‰é˜¶æ®µ
                this.currentPhase = 1;
                this.choiceMade = false;
                
                // è§†é¢‘è·¯å¾„é…ç½®
                this.videos = {
                    phase1: 'é•œå¤´5/1/C05001-1.mp4',    // ç¬¬ä¸€é˜¶æ®µè§†é¢‘ï¼ˆåŸå£°ï¼‰
                    phase2: 'é•œå¤´5/2/C05002-1.mp4',    // ç¬¬äºŒé˜¶æ®µè§†é¢‘
                    phase3Result: 'é•œå¤´5/3/C05003-2.mp4',  // é€‰æ‹©åçš„ç»“æœè§†é¢‘
                    phase3Final: 'é•œå¤´5/3/C05003-1.mp4',   // æœ€ç»ˆè§†é¢‘
                    phase4: 'é•œå¤´5/4/C05004-1.mp4'        // é€€å‡ºåè§†é¢‘
                };
                
                // é•œå¤´6èµ„æº
                this.videos6 = {
                    introAudio: 'é•œå¤´6/1/S06001.MP3',
                    video1: 'é•œå¤´6/1/C06001.mp4',
                    video2: 'é•œå¤´6/2/C06002/C06002-1.mp4',
                    video3: 'é•œå¤´6/3/C06003-1.mp4',
                    video4: 'é•œå¤´6/4/C06004-1.mp4',
                    video5: 'é•œå¤´6/5/C06005-1.mp4'
                };
                
                // é•œå¤´6çŠ¶æ€
                this.scene6Phase = 0;
                this.pendantClicks = 0;
                this.scene6Audio = null;
                
                // é•œå¤´7èµ„æº
                this.videos7 = {
                    video1: 'é•œå¤´7/1/C07001-1.mp4',
                    video2: 'é•œå¤´7/2/C07002-1.mp4',
                    video3: 'é•œå¤´7/3/C07003-1.mp4'
                };

                this.audio7 = {
                    bgm: 'é•œå¤´7/1/S07001.MP3'
                };

                this.scene7Audio = null;
                this.currentChapter = 5; // 5:scene5,6:scene6,7:scene7
                
                this.init();
            }
            
            async init() {
                console.log('ğŸ¬ é•œå¤´5ï¼šè‹±é›„æ•‘ç¾æ–°ç‰ˆ - åˆå§‹åŒ–å¼€å§‹');
                
                try {
                    // æ£€æŸ¥æ˜¯å¦åœ¨iframeä¸­è¿è¡Œï¼Œå¦‚æœæ˜¯åˆ™éšè—æ§åˆ¶é¢æ¿
                    if (window.parent !== window) {
                        const debugControls = document.getElementById('debug-controls');
                        if (debugControls) {
                            debugControls.style.display = 'none';
                            console.log('ğŸ–¥ï¸ åœ¨iframeä¸­è¿è¡Œï¼Œå·²éšè—è°ƒè¯•æ§åˆ¶é¢æ¿');
                        }
                    }
                    
                    // å¼€å§‹ç¬¬ä¸€é˜¶æ®µ
                    await this.startPhase1();
                    
                    // å¼€å§‹èƒŒæ™¯éŸ³ä¹
                    try {
                        this.bgm.volume = 0.4;
                        await this.bgm.play();
                        console.log('ğŸµ èƒŒæ™¯éŸ³ä¹å·²æ’­æ”¾');
                    } catch(e) {
                        console.warn('âš ï¸ èƒŒæ™¯éŸ³ä¹æ’­æ”¾å¤±è´¥ï¼Œå¯èƒ½éœ€è¦ç”¨æˆ·äº¤äº’', e);
                    }
                    
                    // æ·»åŠ æ¶ˆæ¯ç›‘å¬å™¨
                    window.addEventListener('message', (e)=>{
                        if(e.data.type==='cleanup-ui'){
                            this.clearAllUI();
                        } else if(e.data.type==='stop-all-audio'){
                            if(this.bgm){this.bgm.pause();}
                            if(this.scene6Audio){this.scene6Audio.pause();}
                            if(this.scene7Audio){this.scene7Audio.pause();}
                            if(this.mainVideo){this.mainVideo.pause();}
                        } else if(e.data.type==='force-start-scene6'){
                            this.startScene6();
                        } else if(e.data.type==='force-start-scene7'){
                            this.startScene7();
                        }
                    });
                    
                    // æ·»åŠ é”®ç›˜ç›‘å¬å™¨
                    document.addEventListener('keydown',(e)=>{
                        if((e.key==='`'||e.key==='~'||e.code==='Backquote') && window.parent && window.parent!==window){
                            window.parent.postMessage({type:'toggle-console'}, '*');
                        }
                    });
                    
                } catch (error) {
                    console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
                    this.updateStatus('åˆå§‹åŒ–å¤±è´¥');
                }
            }
            
            async startPhase1() {
                console.log('ğŸ¬ å¼€å§‹é˜¶æ®µ1ï¼šæ’­æ”¾C05001-1.mp4');
                this.currentPhase = 1;
                this.updatePhaseDisplay('é˜¶æ®µ1ï¼šå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ');
                this.updateStatus('æ’­æ”¾ç¬¬ä¸€é˜¶æ®µè§†é¢‘');
                this.hideActionButton();
                this.hideChoiceContainer();
                
                // é‡ç½®é€‰æ‹©çŠ¶æ€
                this.choiceMade = false;
                
                // è®¾ç½®è§†é¢‘æº
                this.mainVideo.src = this.videos.phase1;
                this.mainVideo.muted = false; // ä¿ç•™åŸå£°
                this.mainVideo.loop = false;
                this.mainVideo.volume = 1.0;
                
                // æ¸…é™¤æ‰€æœ‰ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨
                this.mainVideo.onended = null;
                this.mainVideo.ontimeupdate = null;
                
                // ç›‘å¬è§†é¢‘ç»“æŸäº‹ä»¶
                this.mainVideo.onended = () => {
                    console.log('âœ… é˜¶æ®µ1è§†é¢‘æ’­æ”¾å®Œæˆï¼Œæ˜¾ç¤º"å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ"æŒ‰é’®');
                    this.showWhatHappenedButton();
                };
                
                try {
                    await this.mainVideo.play();
                    this.updateVideoStatus('é˜¶æ®µ1æ’­æ”¾ä¸­');
                    console.log('âœ… é˜¶æ®µ1è§†é¢‘å¼€å§‹æ’­æ”¾');
                } catch (error) {
                    console.error('âŒ é˜¶æ®µ1è§†é¢‘æ’­æ”¾å¤±è´¥:', error);
                    this.updateStatus('è§†é¢‘æ’­æ”¾å¤±è´¥');
                    this.showManualPlayCover();
                }
            }
            
            showWhatHappenedButton() {
                // é˜²æ­¢é‡å¤æ˜¾ç¤º - æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¾ç¤º
                if (this.actionButton.classList.contains('show')) {
                    console.log('âš ï¸ æŒ‰é’®å·²æ˜¾ç¤ºï¼Œè·³è¿‡é‡å¤æ˜¾ç¤º');
                    return;
                }
                
                console.log('ğŸ”˜ æ˜¾ç¤º"å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ"æŒ‰é’®');
                this.actionButton.textContent = 'å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ';
                this.actionButton.classList.remove('hidden');
                this.actionButton.classList.add('show');
                
                // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼ˆé˜²æ­¢é‡å¤ç»‘å®šï¼‰
                this.actionButton.onclick = () => {
                    console.log('ğŸ”˜ ç”¨æˆ·ç‚¹å‡»"å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ"æŒ‰é’®');
                    this.hideActionButton(); // ç«‹å³éšè—æŒ‰é’®
                    this.startPhase2();
                };
            }
            
            async startPhase2() {
                console.log('ğŸ¬ å¼€å§‹é˜¶æ®µ2ï¼šæ’­æ”¾C05002-1.mp4');
                this.currentPhase = 2;
                this.updatePhaseDisplay('é˜¶æ®µ2ï¼šå†²çªå‡çº§');
                this.updateStatus('æ’­æ”¾ç¬¬äºŒé˜¶æ®µè§†é¢‘');
                this.hideActionButton();
                
                // è®¾ç½®è§†é¢‘æº
                this.mainVideo.src = this.videos.phase2;
                this.mainVideo.muted = false; // ä¿ç•™åŸå£°
                this.mainVideo.loop = false;
                this.mainVideo.volume = 1.0;
                
                // æ¸…é™¤æ‰€æœ‰ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨
                this.mainVideo.onended = null;
                this.mainVideo.ontimeupdate = null;
                
                // ç›‘å¬æ—¶é—´æ›´æ–°ï¼Œåœ¨æœ€åä¸€å¸§æš‚åœ
                this.mainVideo.ontimeupdate = () => {
                    // å½“è§†é¢‘æ¥è¿‘ç»“æŸæ—¶æš‚åœå¹¶æ˜¾ç¤ºé€‰æ‹©æŒ‰é’®
                    if (this.mainVideo.duration > 0 && 
                        this.mainVideo.currentTime >= this.mainVideo.duration - 0.1) {
                        this.mainVideo.pause();
                        this.mainVideo.ontimeupdate = null; // ç§»é™¤ç›‘å¬
                        console.log('âœ… é˜¶æ®µ2è§†é¢‘æš‚åœåœ¨æœ€åä¸€å¸§ï¼Œæ˜¾ç¤ºé€‰æ‹©æŒ‰é’®');
                        this.showChoiceButtons();
                    }
                };
                
                try {
                    await this.mainVideo.play();
                    this.updateVideoStatus('é˜¶æ®µ2æ’­æ”¾ä¸­');
                    console.log('âœ… é˜¶æ®µ2è§†é¢‘å¼€å§‹æ’­æ”¾');
                } catch (error) {
                    console.error('âŒ é˜¶æ®µ2è§†é¢‘æ’­æ”¾å¤±è´¥:', error);
                    this.updateStatus('è§†é¢‘æ’­æ”¾å¤±è´¥');
                }
            }
            
            showChoiceButtons() {
                if (document.getElementById('choice-overlay')) return;

                this.updatePhaseDisplay('é˜¶æ®µ3ï¼šé€‰æ‹©è¡ŒåŠ¨');

                // åˆ›å»ºåŠé€æ˜é»‘è‰²é®ç½©
                const overlay = document.createElement('div');
                overlay.id = 'choice-overlay';
                overlay.style.cssText = `
                    position: fixed;top:0;left:0;width:100vw;height:100vh;
                    background: rgba(0,0,0,0.55);z-index:999998;
                    display:flex;flex-direction:column;align-items:center;justify-content:flex-end;
                    gap:15px;padding-bottom:10vh;`
                document.body.appendChild(overlay);

                const choices = ['1','2','3'];
                choices.forEach((id,idx)=>{
                    const img = document.createElement('img');
                    img.src = `é•œå¤´5/3/${id}.png`;
                    img.style.cssText = `width:650px;max-width:85vw;height:auto;transition:transform 0.3s;`;

                    if(idx===0){
                        // ç¬¬ä¸€ä¸ªæŒ‰é’®å‘å…‰å¹¶å¯ç‚¹å‡»
                        img.style.filter='drop-shadow(0 0 14px rgba(255,120,40,0.85))';
                        img.style.animation='pulseGlowFilter 1.5s infinite alternate';
                        img.style.cursor='pointer';
                        img.onmouseenter=()=>img.style.transform='scale(1.05)';
                        img.onmouseleave=()=>img.style.transform='scale(1)';
                        img.onclick=()=>{
                            overlay.remove();
                            this.makeChoice('fight');
                        };
                    } else {
                        // 2ã€3æŒ‰é’®ç¦ç”¨
                        img.style.cursor='default';
                        img.style.pointerEvents='none';
                        img.style.opacity='0.7';
                    }

                    overlay.appendChild(img);
                });
            }
            
            async makeChoice(choice) {
                if (this.choiceMade) return; // é˜²æ­¢é‡å¤é€‰æ‹©
                
                this.choiceMade = true;
                console.log(`âœ… ç”¨æˆ·é€‰æ‹©ï¼š${choice}`);
                this.updateStatus('æ’­æ”¾é€‰æ‹©ç»“æœ');
                
                // æ’­æ”¾é€‰æ‹©ç»“æœè§†é¢‘
                await this.playChoiceResult();
            }
            
            async playChoiceResult() {
                console.log('ğŸ¬ æ’­æ”¾é€‰æ‹©ç»“æœè§†é¢‘ï¼šC05003-2.mp4');
                
                // ğŸ¥ é¢„åŠ è½½ä¸‹ä¸€ä¸ªè§†é¢‘ï¼Œé¿å…åˆ‡æ¢æ—¶é»‘å±
                if (window.videoPreloader) {
                    console.log('ğŸ¥ é¢„åŠ è½½æœ€ç»ˆè§†é¢‘ï¼Œé¿å…åˆ‡æ¢é»‘å±...');
                    window.videoPreloader.preloadVideo(this.videos.phase3Final);
                }
                
                // è®¾ç½®è§†é¢‘æº
                this.mainVideo.src = this.videos.phase3Result;
                this.mainVideo.muted = false;
                this.mainVideo.loop = false;
                this.mainVideo.volume = 1.0;
                
                // æ¸…é™¤æ‰€æœ‰ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨
                this.mainVideo.onended = null;
                this.mainVideo.ontimeupdate = null;
                
                // ç›‘å¬è§†é¢‘ç»“æŸäº‹ä»¶
                this.mainVideo.onended = () => {
                    console.log('âœ… é€‰æ‹©ç»“æœè§†é¢‘æ’­æ”¾å®Œæˆï¼Œå¼€å§‹éœ‡æ’¼è½¬åœº');
                    this.startShockTransition();
                };
                
                try {
                    await this.mainVideo.play();
                    this.updateVideoStatus('é€‰æ‹©ç»“æœæ’­æ”¾ä¸­');
                    console.log('âœ… é€‰æ‹©ç»“æœè§†é¢‘å¼€å§‹æ’­æ”¾');
                } catch (error) {
                    console.error('âŒ é€‰æ‹©ç»“æœè§†é¢‘æ’­æ”¾å¤±è´¥:', error);
                    this.updateStatus('è§†é¢‘æ’­æ”¾å¤±è´¥');
                }
            }
            
            startShockTransition() {
                console.log('ğŸ’¥ å¼€å§‹éœ‡æ’¼è½¬åœºæ•ˆæœ');
                this.updateStatus('éœ‡æ’¼è½¬åœºä¸­');
                
                // ä½¿ç”¨é•œå¤´4é£æ ¼çš„éœ‡æ’¼è½¬åœºæ•ˆæœ
                this.triggerAwakeningShockEffect(() => {
                    this.playFinalVideo();
                });
            }
            
            triggerAwakeningShockEffect(callback) {
                console.log('ğŸ’¥ è§¦å‘è§‰é†’éœ‡æ’¼è½¬åœºæ•ˆæœ');
                
                // æ·»åŠ éœ‡æ’¼æ•ˆæœåˆ°ä¸»å®¹å™¨
                this.container.classList.add('awakening-shock-effect');
                document.body.classList.add('body-shake-awakening');
                
                // åˆ›å»ºè§‰é†’é—ªå…‰æ•ˆæœ
                this.createAwakeningFlash();
                
                // åˆ›å»ºå†²å‡»æ³¢æ•ˆæœ
                this.createAwakeningShockwave();
                
                // è®¾å¤‡éœ‡åŠ¨ (å¦‚æœæ”¯æŒ)
                if (navigator.vibrate) {
                    navigator.vibrate([100, 50, 300, 100, 300, 100, 200, 50, 100]);
                }
                
                // æ˜¾ç¤ºéœ‡æ’¼æ•ˆæœçŠ¶æ€
                this.updateStatus('âš¡ éœ‡æ’¼èƒ½é‡çˆ†å‘ä¸­...');
                
                // ç§»é™¤éœ‡æ’¼æ•ˆæœç±» - é€‚é…æ–°çš„0.5sé€Ÿåº¦
                setTimeout(() => {
                    this.container.classList.remove('awakening-shock-effect');
                    document.body.classList.remove('body-shake-awakening');
                    this.updateStatus('ğŸŒŸ éœ‡æ’¼è½¬åœºå®Œæˆ');
                    console.log('âœ… éœ‡æ’¼è½¬åœºæ•ˆæœå®Œæˆ');
                    
                    // æ‰§è¡Œå›è°ƒ
                    if (callback) {
                        callback();
                    }
                }, 500); // 0.5s
            }
            
            createAwakeningFlash() {
                const flash = document.createElement('div');
                flash.className = 'awakening-flash';
                flash.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100vh;
                    background: radial-gradient(circle, rgba(255,255,255,0.6) 0%, rgba(255,255,255,0.3) 30%, rgba(255,255,255,0.1) 60%, transparent 80%);
                    z-index: 9998;
                    opacity: 0;
                    pointer-events: none;
                    transition: opacity 0.12s ease-out;
                `;
                document.body.appendChild(flash);
                
                // æ›´æŸ”å’Œçš„é—ªå…‰æ—¶åºï¼Œå¿«é€Ÿäº®èµ·ç„¶åæŸ”å’Œæ¶ˆé€€
                setTimeout(() => flash.style.opacity = '1', 75);   // çˆ†å‘ç‚¹äº®èµ·
                setTimeout(() => flash.style.opacity = '0.5', 150); // å¼€å§‹æ¶ˆé€€
                setTimeout(() => flash.style.opacity = '0.2', 250); // ç»§ç»­æ¶ˆé€€
                setTimeout(() => flash.style.opacity = '0', 400);   // å®Œå…¨æ¶ˆå¤±
                setTimeout(() => flash.remove(), 500);
            }
            
            createAwakeningShockwave() {
                // åˆ›å»º2å±‚æŸ”å’Œçš„ç™½è‰²å†²å‡»æ³¢
                for (let i = 0; i < 2; i++) {
                    setTimeout(() => {
                        const shockwave = document.createElement('div');
                        shockwave.style.cssText = `
                            position: fixed;
                            top: 50%;
                            left: 50%;
                            width: 60px;
                            height: 60px;
                            border: ${2 - i}px solid rgba(255, 255, 255, ${0.4 - i * 0.1});
                            border-radius: 50%;
                            z-index: 9997;
                            animation: awakening-shockwave 0.5s ease-out;
                            animation-delay: ${i * 0.1}s;
                            pointer-events: none;
                            transform: translate(-50%, -50%) scale(0);
                            box-shadow: 0 0 ${15 - i * 5}px rgba(255, 255, 255, ${0.3 - i * 0.1});
                        `;
                        document.body.appendChild(shockwave);
                        
                        setTimeout(() => shockwave.remove(), 600);
                    }, i * 100); // é€‚ä¸­çš„é—´éš”
                }
            }
            
            async playFinalVideo() {
                console.log('ğŸ¬ æ’­æ”¾æœ€ç»ˆè§†é¢‘ï¼šC05003-1.mp4');
                this.updatePhaseDisplay('é˜¶æ®µ4ï¼šæ•…äº‹ç»“æŸ');
                this.updateStatus('æ’­æ”¾æœ€ç»ˆè§†é¢‘');
                
                // ğŸ¥ ç¡®ä¿æœ€ç»ˆè§†é¢‘å®Œå…¨åŠ è½½åå†æ’­æ”¾ï¼Œé¿å…é»‘å±
                const waitForVideoReady = () => {
                    return new Promise((resolve) => {
                        if (this.mainVideo.readyState >= 3) { // HAVE_FUTURE_DATA
                            console.log('âœ… æœ€ç»ˆè§†é¢‘å·²å‡†å¤‡å°±ç»ª');
                            resolve();
                        } else {
                            console.log('â³ ç­‰å¾…æœ€ç»ˆè§†é¢‘åŠ è½½...');
                            const checkReady = () => {
                                if (this.mainVideo.readyState >= 3) {
                                    console.log('âœ… æœ€ç»ˆè§†é¢‘åŠ è½½å®Œæˆ');
                                    resolve();
                                } else {
                                    setTimeout(checkReady, 50);
                                }
                            };
                            checkReady();
                        }
                    });
                };
                
                // è®¾ç½®è§†é¢‘æº
                this.mainVideo.src = this.videos.phase3Final;
                this.mainVideo.muted = false;
                this.mainVideo.loop = false;
                this.mainVideo.volume = 1.0;
                
                // æ¸…é™¤ä¹‹å‰çš„ç›‘å¬å™¨
                this.mainVideo.onended = null;
                this.mainVideo.ontimeupdate = null;

                // ä½¿ç”¨endedäº‹ä»¶ï¼Œæ’­æ”¾å®Œæ¯•åå®šæ ¼æœ€åä¸€å¸§å¹¶æç¤º
                this.mainVideo.onended = () => {
                    // å®šæ ¼æœ€åä¸€å¸§
                    this.mainVideo.pause();
                    console.log('â¸ï¸ æœ€ç»ˆè§†é¢‘æ’­æ”¾ç»“æŸå¹¶å®šæ ¼');
                    this.showExitPrompt();
                };
                
                try {
                    // ç­‰å¾…è§†é¢‘å‡†å¤‡å°±ç»ª
                    await waitForVideoReady();
                    
                    await this.mainVideo.play();
                    this.updateVideoStatus('æœ€ç»ˆè§†é¢‘æ’­æ”¾ä¸­');
                    console.log('âœ… æœ€ç»ˆè§†é¢‘å¼€å§‹æ’­æ”¾');
                } catch (error) {
                    console.error('âŒ æœ€ç»ˆè§†é¢‘æ’­æ”¾å¤±è´¥:', error);
                    this.updateStatus('è§†é¢‘æ’­æ”¾å¤±è´¥');
                }
            }
            
            completeScene() {
                console.log('âœ… é•œå¤´5å®Œæˆ');
                this.updateStatus('é•œå¤´å®Œæˆ');
                
                // ä¸å†æ˜¾ç¤ºæˆ˜æ–—èƒœåˆ©ç•Œé¢ï¼ˆå·²å»æ‰ï¼‰
            }
            
            // å·¥å…·æ–¹æ³•
            cleanupScene() {
                console.log('ğŸ§¹ æ¸…ç†é•œå¤´5åœºæ™¯çŠ¶æ€');
                
                // æ¸…é™¤æ‰€æœ‰è§†é¢‘äº‹ä»¶ç›‘å¬å™¨
                if (this.mainVideo) {
                    this.mainVideo.onended = null;
                    this.mainVideo.ontimeupdate = null;
                    this.mainVideo.pause();
                }
                
                // éšè—æ‰€æœ‰UIå…ƒç´ 
                this.hideActionButton();
                this.hideChoiceContainer();
                
                // é‡ç½®çŠ¶æ€
                this.currentPhase = 1;
                this.choiceMade = false;
                
                // ç§»é™¤å¯èƒ½å­˜åœ¨çš„èƒœåˆ©ç•Œé¢
                const victoryMessage = document.querySelector('div[style*="z-index: 99999"]');
                if (victoryMessage) {
                    victoryMessage.remove();
                }
                
                // åœæ­¢èƒŒæ™¯éŸ³ä¹
                if (this.bgm) {
                    this.bgm.pause();
                    this.bgm.currentTime = 0;
                }
            }
            
            updatePhaseDisplay(phaseText) {
                this.phaseIndicator.textContent = phaseText;
                this.currentPhaseSpan.textContent = this.currentPhase;
            }
            
            updateStatus(status) {
                this.sceneStatus.textContent = status;
            }
            
            updateVideoStatus(status) {
                this.videoStatus.textContent = status;
            }
            
            hideActionButton() {
                this.actionButton.classList.add('hidden');
                this.actionButton.classList.remove('show');
                this.actionButton.classList.remove('center');
            }
            
            hideChoiceContainer() {
                this.choiceContainer.classList.remove('show');
                this.choiceContainer.classList.add('hidden');
            }
            
            // æµ‹è¯•å’Œè·³è½¬æ–¹æ³•
            async skipToPhase(phase) {
                console.log(`âš¡ å¿«é€Ÿè·³è½¬åˆ°é˜¶æ®µ${phase}`);
                
                switch (phase) {
                    case 2:
                        await this.startPhase2();
                        break;
                    case 3:
                        this.showChoiceButtons();
                        break;
                    default:
                        await this.startPhase1();
                }
            }
            
            testShockTransition() {
                console.log('ğŸ§ª æµ‹è¯•éœ‡æ’¼è½¬åœºæ•ˆæœ');
                this.triggerAwakeningShockEffect();
            }
            
            restartScene() {
                console.log('ğŸ”„ é‡æ–°å¼€å§‹é•œå¤´5');
                
                // æ¸…ç†åœºæ™¯çŠ¶æ€
                this.cleanupScene();
                
                // é‡æ–°åˆå§‹åŒ–
                this.init();
            }
            
            nextScene() {
                console.log('â¡ï¸ è¿›å…¥é•œå¤´6æµç¨‹');

                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({ type: 'scene5-complete' }, '*');
                    // åœ¨çˆ¶é¡µé¢ä¸­ä»ç»§ç»­æ’­æ”¾é•œå¤´6
                    this.startScene6();
                } else {
                    this.startScene6();
                }
            }
            
            // æ‰‹åŠ¨æ’­æ”¾è¦†ç›–å±‚
            showManualPlayCover() {
                if (document.getElementById('manual-play-cover')) return;
                const cover = document.createElement('div');
                cover.id = 'manual-play-cover';
                cover.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100vh;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: #fff;
                    font-size: 18px;
                    z-index: 999999;
                    cursor: pointer;
                `;
                cover.textContent = 'ç‚¹å‡»ä»¥ç»§ç»­æ’­æ”¾';
                cover.addEventListener('click', async () => {
                    cover.remove();
                    this.mainVideo.muted = false;
                    try {
                        await this.mainVideo.play();
                        this.updateVideoStatus('é˜¶æ®µ1æ’­æ”¾ä¸­');
                        this.updateStatus('æ’­æ”¾ä¸­');
                    } catch (e) {
                        console.error('âŒ ç”¨æˆ·ç‚¹å‡»åä»æ— æ³•æ’­æ”¾:', e);
                        this.updateStatus('æ’­æ”¾å¤±è´¥');
                    }
                });
                document.body.appendChild(cover);
            }
            
            showExitPrompt() {
                if (document.getElementById('exit-prompt')) return;
                const prompt = document.createElement('div');
                prompt.id = 'exit-prompt';
                prompt.style.cssText = `
                    position: fixed;top:0;left:0;width:100vw;height:100vh;
                    background: rgba(0,0,0,0.6);
                    display: flex;flex-direction: column;align-items: center;justify-content: flex-end;gap: 12px;padding-bottom:20vh;
                    color: #fff;
                    font-size: 22px;
                    z-index: 999999;
                    cursor: pointer;
                `;
                prompt.innerHTML = `<div style="font-size:48px; animation: handShake 1.2s infinite;">ğŸ‘‡</div><div style="font-size:20px;">ç‚¹å‡»å±å¹•ç¡®è®¤</div>`;
                prompt.addEventListener('click', () => {
                    prompt.remove();
                    this.playPhase4Video();
                });
                document.body.appendChild(prompt);
            }

            async playPhase4Video() {
                console.log('ğŸ¬ æ’­æ”¾é€€å‡ºåè§†é¢‘ï¼šC05004-1.mp4');
                // é»‘è‰²æ·¡å…¥é®ç½©
                const fade = document.createElement('div');
                fade.style.cssText = `
                    position: fixed;top:0;left:0;width:100vw;height:100vh;
                    background:#000;opacity:0;z-index:999998;pointer-events:none;
                    transition:opacity 0.6s;`
                document.body.appendChild(fade);
                requestAnimationFrame(()=>{fade.style.opacity='1'});
                await new Promise(r=>setTimeout(r,600));
                // åˆ‡æ¢è§†é¢‘åæ·¡å‡º
                this.updatePhaseDisplay('é˜¶æ®µ5ï¼šç»“æŸè½¬åœº');
                this.updateStatus('æ’­æ”¾ç»“æŸè§†é¢‘');

                // è®¾ç½®è§†é¢‘æº
                this.mainVideo.src = this.videos.phase4;
                this.mainVideo.muted = false;
                this.mainVideo.loop = false;
                this.mainVideo.volume = 1.0;

                // æ’­æ”¾å®Œç»“æŸè§†é¢‘åï¼Œæ˜¾ç¤º"è·Ÿä¸Šä»–ï¼"æŒ‰é’®
                this.mainVideo.onended = () => {
                    console.log('ğŸ ç»“æŸè§†é¢‘æ’­æ”¾å®Œæ¯•ï¼Œæ˜¾ç¤ºè·Ÿä¸Šä»–æŒ‰é’®');
                    this.showFollowButton();
                };

                try {
                    await this.mainVideo.play();
                    this.updateVideoStatus('ç»“æŸè§†é¢‘æ’­æ”¾ä¸­');
                    // æ·¡å‡ºé®ç½©
                    fade.style.opacity='0';
                    setTimeout(()=>fade.remove(),600);
                } catch (error) {
                    console.error('âŒ ç»“æŸè§†é¢‘æ’­æ”¾å¤±è´¥:', error);
                    this.updateStatus('æ’­æ”¾å¤±è´¥');
                    fade.remove();
                }
            }

            showFollowButton() {
                if (this.actionButton.classList.contains('show')) return;
                this.actionButton.textContent = 'è·Ÿä¸Šä»–ï¼';
                this.actionButton.classList.add('center');
                this.actionButton.classList.remove('hidden');
                this.actionButton.classList.add('show');
                this.actionButton.onclick = () => {
                    this.hideActionButton();
                    this.nextScene();
                };
            }

            /* ---------------- é•œå¤´6æµç¨‹ ---------------- */
            startScene6() {
                console.log('ğŸ¬ é•œå¤´6å¯åŠ¨');
                this.currentPhase = 6;
                this.updatePhaseDisplay('é•œå¤´6ï¼šè’é‡å¤œè·¯');
                this.updateStatus('æ’­æ”¾ç¯å¢ƒéŸ³');

                // æ¸…ç†å¯èƒ½é—ç•™çš„UI
                this.clearAllUI();
                // åœæ­¢èƒŒæ™¯éŸ³å¹¶æ¸…ç©º
                if(this.bgm){
                    this.bgm.pause();
                    this.bgm.currentTime=0;
                    this.bgm.src='';
                }

                // æ’­æ”¾å¾ªç¯èƒŒæ™¯éŸ³
                if (!this.scene6Audio) {
                    this.scene6Audio = new Audio(this.videos6.introAudio);
                    this.scene6Audio.loop = true;
                }
                this.scene6Audio.volume = 0.6;
                this.scene6Audio.play().catch(e=>console.warn('âš ï¸ é•œå¤´6éŸ³é¢‘æ’­æ”¾å¤±è´¥',e));

                // æ’­æ”¾ç¬¬ä¸€ä¸ªè§†é¢‘
                this.playScene6Video1();
            }

            playScene6Video1() {
                this.playWithFade(this.videos6.video1, ()=>{
                    console.log('âœ… é•œå¤´6-1 æ’­æ”¾å®Œæ¯•');
                    this.showContinueWalkButton();
                });

                this.updateVideoStatus('é•œå¤´6-1 æ’­æ”¾ä¸­');
            }

            showContinueWalkButton() {
                this.actionButton.textContent = 'ç»§ç»­èµ°';
                this.actionButton.classList.add('center');
                this.actionButton.classList.remove('hidden');
                this.actionButton.classList.add('show');
                this.actionButton.onclick = () => {
                    this.hideActionButton();
                    this.playScene6Video2();
                };
            }

            playScene6Video2() {
                this.playWithFade(this.videos6.video2, ()=>{
                    console.log('âœ… é•œå¤´6-2 æ’­æ”¾å®Œæ¯•');
                    this.showRemovePendantButton();
                });
                this.updateVideoStatus('é•œå¤´6-2 æ’­æ”¾ä¸­');
            }

            showRemovePendantButton() {
                this.actionButton.textContent = 'å–ä¸‹ç‰ä½©';
                this.actionButton.classList.add('center');
                this.actionButton.classList.remove('hidden');
                this.actionButton.classList.add('show');
                this.actionButton.onclick = () => {
                    this.hideActionButton();
                    this.playScene6Video3();
                };
            }

            playScene6Video3() {
                this.playWithFade(this.videos6.video3, ()=>{
                    console.log('âœ… é•œå¤´6-3 æ’­æ”¾å®Œæ¯•');
                    this.showScene6Choices();
                });
                this.updateVideoStatus('é•œå¤´6-3 æ’­æ”¾ä¸­');
            }

            showScene6Choices() {
                if (document.getElementById('scene6-choice-overlay')) return;
                const overlay = document.createElement('div');
                overlay.id = 'scene6-choice-overlay';
                overlay.style.cssText = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.55);z-index:999998;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;gap:15px;padding-bottom:10vh;`;
                document.body.appendChild(overlay);

                const choiceData = [
                    {src:'é•œå¤´6/3/1.png', clickable:true, glow:true, value:'brave'},
                    {src:'é•œå¤´6/3/2.png', clickable:false, glow:false, value:'hide'}
                ];

                choiceData.forEach(data=>{
                    const img = document.createElement('img');
                    img.src = data.src;
                    img.style.cssText = `width:650px;max-width:85vw;height:auto;margin-bottom:15px;transition:transform 0.3s;`;

                    if(data.glow){
                        img.style.filter='drop-shadow(0 0 14px rgba(255,120,40,0.85))';
                        img.style.animation='pulseGlowFilter 1.5s infinite alternate';
                    }

                    img.onmouseenter=()=>img.style.transform='scale(1.05)';
                    img.onmouseleave=()=>img.style.transform='scale(1)';

                    if(data.clickable){
                        img.style.cursor='pointer';
                        img.onclick=()=>{
                            overlay.remove();
                            console.log('ğŸ”˜ åœºæ™¯6é€‰æ‹©',data.value);
                            this.playScene6Video4();
                        };
                    } else {
                        img.style.cursor='default';
                        img.style.pointerEvents='none';
                        img.style.opacity='0.7';
                    }

                    overlay.appendChild(img);
                });
            }

            playScene6Video4() {
                this.playWithFade(this.videos6.video4, ()=>{
                    console.log('âœ… é•œå¤´6-4 æ’­æ”¾å®Œæ¯•');
                    this.showTouchPendantButton();
                });
                this.updateVideoStatus('é•œå¤´6-4 æ’­æ”¾ä¸­');
            }

            showTouchPendantButton() {
                this.pendantClicks = 0;
                this.actionButton.textContent = 'è§¦æ‘¸ç‰ä½©ï¼ˆ0/3ï¼‰';
                this.actionButton.classList.add('center');
                this.actionButton.classList.remove('hidden');
                this.actionButton.classList.add('show');
                this.actionButton.onclick = () => {
                    this.handlePendantTouch();
                };
            }

            handlePendantTouch() {
                this.pendantClicks += 1;
                this.actionButton.textContent = `è§¦æ‘¸ç‰ä½©ï¼ˆ${this.pendantClicks}/3ï¼‰`;
                // éœ‡åŠ¨/æŠ–åŠ¨æ•ˆæœ
                this.container.classList.add('shake');
                setTimeout(()=>this.container.classList.remove('shake'),400);

                if (this.pendantClicks >= 3) {
                    this.hideActionButton();
                    this.playScene6Video5();
                }
            }

            playScene6Video5() {
                this.playWithFade(this.videos6.video5, ()=>{
                    console.log('ğŸ é•œå¤´6æµç¨‹ç»“æŸ');
                    if(window.parent && window.parent!==window){
                        window.parent.postMessage({type:'scene6-complete'}, '*');
                    }
                    this.showScene7Prompt();
                });

                // å–æ¶ˆ any timeupdate shake logic
                this.mainVideo.ontimeupdate = null;

                this.updateVideoStatus('é•œå¤´6-5 æ’­æ”¾ä¸­');
            }

            showScene7Prompt() {
                if(document.getElementById('scene7-start-prompt')) return;
                const prompt = document.createElement('div');
                prompt.id = 'scene7-start-prompt';
                prompt.style.cssText = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.6);display:flex;flex-direction:column;align-items:center;justify-content:flex-end;padding-bottom:20vh;gap:12px;color:#fff;z-index:999999;cursor:pointer;`;
                prompt.innerHTML = `<div style="font-size:48px;animation:handShake 1.2s infinite;">ğŸ‘‡</div><div style="font-size:20px;">ç‚¹å‡»å±å¹•ç»§ç»­</div>`;
                prompt.onclick = ()=>{
                    prompt.remove();
                    // åœæ­¢é•œå¤´6èƒŒæ™¯éŸ³
                    if(this.scene6Audio){
                        this.scene6Audio.pause();
                        this.scene6Audio=null;
                    }
                    this.startScene7();
                };
                document.body.appendChild(prompt);
            }

            /* ----------- é•œå¤´7æµç¨‹ ------------- */
            startScene7(){
                console.log('ğŸ¬ å¯åŠ¨é•œå¤´7');
                this.currentChapter=7;
                this.updatePhaseDisplay('é•œå¤´7ï¼šæœªçŸ¥æ—…ç¨‹');
                this.playScene7Video1();
                if(window.parent && window.parent!==window){
                    window.parent.postMessage({type:'scene7-start'}, '*');
                }
            }

            playScene7Video1(){
                this.playWithFade(this.videos7.video1, ()=>{
                    console.log('âœ… é•œå¤´7-1 æ’­æ”¾å®Œæ¯•');
                    this.showScene7WhatHappenedButton();
                });
                this.updateVideoStatus('é•œå¤´7-1 æ’­æ”¾ä¸­');
            }

            showScene7WhatHappenedButton(){
                this.actionButton.textContent='å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ';
                this.actionButton.classList.add('center');
                this.actionButton.classList.remove('hidden');
                this.actionButton.classList.add('show');
                this.actionButton.onclick=()=>{
                    this.hideActionButton();
                    this.playScene7Video2();
                };
            }

            playScene7Video2(){
                // è‹¥èƒŒæ™¯éŸ³ä¹æœªå¼€å¯ï¼Œåˆ™ç«‹å³å¯åŠ¨
                if(!this.scene7Audio){
                    this.scene7Audio = new Audio(this.audio7.bgm);
                    this.scene7Audio.loop = true;
                    this.scene7Audio.volume = 0.5;
                    this.scene7Audio.play().catch(e=>console.warn('âš ï¸ é•œå¤´7 BGM æ’­æ”¾å¤±è´¥',e));
                }

                this.playWithFade(this.videos7.video2, ()=>{
                    console.log('âœ… é•œå¤´7-2 æ’­æ”¾å®Œæ¯•');
                    this.showMeetMasterButton();
                });
                this.updateVideoStatus('é•œå¤´7-2 æ’­æ”¾ä¸­');
            }

            showMeetMasterButton(){
                this.actionButton.textContent='æ‹œè§å¸ˆçˆ¶';
                this.actionButton.classList.add('center');
                this.actionButton.classList.remove('hidden');
                this.actionButton.classList.add('show');
                this.actionButton.onclick=()=>{
                    this.hideActionButton();
                    this.playScene7Video3();
                };
            }

            playScene7Video3(){
                this.playWithFade(this.videos7.video3, ()=>{
                    console.log('ğŸ é•œå¤´7æµç¨‹ç»“æŸ');
                    if(window.parent && window.parent!==window){
                        window.parent.postMessage({type:'scene7-complete'}, '*');
                    }
                });
                this.updateVideoStatus('é•œå¤´7-3 æ’­æ”¾ä¸­');
            }
            /* ----------- é•œå¤´7æµç¨‹ç»“æŸ ------------- */

            // é€šç”¨å¸¦é»‘å¹•æ·¡å…¥æ·¡å‡ºçš„è§†é¢‘æ’­æ”¾æ–¹æ³•
            async playWithFade(src, onEndedCallback){
                await this.crossfadeMainVideo(src, {muted:false,loop:false});
                this.mainVideo.onended=()=>{ if(typeof onEndedCallback==='function') onEndedCallback(); };
            }

            crossfadeMainVideo(newSrc, { muted=false, loop=false, autoplay=true }={}){
                return new Promise((resolve)=>{
                    if(this.mainVideo.src.includes(newSrc)){
                        resolve(this.mainVideo);return;
                    }
                    const nextVideo=document.createElement('video');
                    nextVideo.className=this.mainVideo.className||'';
                    nextVideo.preload='auto';
                    nextVideo.muted=muted;
                    nextVideo.loop=loop;
                    nextVideo.playsInline=true;
                    nextVideo.style.cssText='position:absolute;top:0;left:0;width:100%;height:100%;object-fit:contain;opacity:0;transition:opacity 0.4s ease;z-index:1;';
                    this.container.appendChild(nextVideo);

                    const doPlay=()=>{
                        if(autoplay){nextVideo.play().catch(()=>{});}            
                        requestAnimationFrame(()=>{
                            nextVideo.style.opacity='1';
                            this.mainVideo.style.transition='opacity 0.4s ease';
                            this.mainVideo.style.opacity='0';
                            setTimeout(()=>{
                                try{this.mainVideo.pause();}catch(e){}
                                if(this.mainVideo.parentNode){this.mainVideo.parentNode.removeChild(this.mainVideo);}    
                                this.mainVideo=nextVideo;
                                resolve(nextVideo);
                            },400);
                        });
                    };

                    // ä½¿ç”¨é¢„åŠ è½½å™¨
                    if(window.videoPreloader){
                        const pre=window.videoPreloader.getPreloadedVideo(newSrc);
                        if(pre){nextVideo.src=newSrc;} else {window.videoPreloader.preloadVideo(newSrc).finally(()=>{nextVideo.src=newSrc;});}
                    } else { nextVideo.src=newSrc; }

                    nextVideo.addEventListener('loadeddata',()=>doPlay());
                });
            }

            clearAllUI(){
                this.hideActionButton();
                ['choice-overlay','scene6-choice-overlay','scene7-start-prompt'].forEach(id=>{
                    const el=document.getElementById(id);
                    if(el) el.remove();
                });
            }
        }
        
        // å…¨å±€å®ä¾‹
        let scene5;
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            scene5 = new Scene5NewController();
        });
        
        // æ·»åŠ å¿«æ·é”®æ”¯æŒ
        document.addEventListener('keydown', (e) => {
            if (!scene5) return;
            
            switch(e.key) {
                case '1':
                    scene5.skipToPhase(1);
                    break;
                case '2':
                    scene5.skipToPhase(2);
                    break;
                case '3':
                    scene5.skipToPhase(3);
                    break;
                case ' ':
                    e.preventDefault();
                    if (scene5.currentPhase === 1 && !scene5.actionButton.classList.contains('hidden')) {
                        scene5.startPhase2();
                    }
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (scene5.currentPhase === 3 && !scene5.choiceMade) {
                        scene5.makeChoice('fight');
                    }
                    break;
                case 'r':
                case 'R':
                    scene5.restartScene();
                    break;
                case 'n':
                case 'N':
                    scene5.nextScene();
                    break;
                case 's':
                case 'S':
                    scene5.testShockTransition();
                    break;
            }
        });
        
        console.log('ğŸ® é•œå¤´5æ§åˆ¶ï¼šæ•°å­—é”®1-3=è·³è½¬é˜¶æ®µ, ç©ºæ ¼=ç»§ç»­, å›è½¦=é€‰æ‹©1, S=æµ‹è¯•éœ‡æ’¼è½¬åœº, R=é‡å¯, N=ä¸‹ä¸€é•œå¤´');
    </script>
    
    <!-- å¼•å…¥è§†é¢‘é¢„åŠ è½½ç³»ç»Ÿ -->
    <script src="video-preloader.js"></script>
</body>
</html> 