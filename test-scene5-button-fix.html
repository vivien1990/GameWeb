<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>镜头5按钮修复验证</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
            font-family: Arial, sans-serif;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .fix-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #2a2a2a;
            border-radius: 10px;
        }
        
        .section-title {
            color: #ffcc00;
            margin-bottom: 15px;
        }
        
        .fix-status {
            background: #2d5a2d;
            color: #90EE90;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .problem-solution {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .problem, .solution {
            padding: 15px;
            border-radius: 8px;
        }
        
        .problem {
            background: #5a2d2d;
            color: #ffaaaa;
        }
        
        .solution {
            background: #2d5a2d;
            color: #90EE90;
        }
        
        .code-sample {
            background: #333;
            color: #ccc;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        
        .control-button {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 20px;
            margin: 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .control-button:hover {
            background: linear-gradient(45deg, #45a049, #4CAF50);
        }
        
        .feature-list {
            list-style: none;
            padding: 0;
        }
        
        .feature-list li {
            padding: 8px 0;
            border-bottom: 1px solid #444;
        }
        
        .feature-list li:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 style="color: #ffcc00; text-align: center;">🔧 镜头5按钮重复问题修复</h1>
        <p style="text-align: center; color: #ccc;">验证按钮重复出现的修复和战斗胜利界面的添加</p>
        
        <!-- 修复状态总览 -->
        <div class="fix-status">
            <h3>✅ 修复完成状态</h3>
            <ul>
                <li>✅ <strong>按钮重复问题</strong>：添加重复检查，防止按钮多次显示</li>
                <li>✅ <strong>事件重复绑定</strong>：添加保护机制，防止多次绑定点击事件</li>
                <li>✅ <strong>战斗胜利界面</strong>：添加华丽的胜利提示界面</li>
                <li>✅ <strong>状态重置</strong>：改进重启逻辑，确保状态正确重置</li>
            </ul>
        </div>
        
        <!-- 问题1：按钮重复显示 -->
        <div class="fix-section">
            <h3 class="section-title">🔘 问题1：按钮重复显示修复</h3>
            
            <div class="problem-solution">
                <div class="problem">
                    <h4>❌ 修复前问题</h4>
                    <div class="code-sample">// 旧版没有重复检查
showWhatHappenedButton() {
  this.actionButton.classList.remove('hidden');
  this.actionButton.classList.add('show');
  // 可能多次调用，导致按钮重复显示
}</div>
                    <p>问题：没有检查按钮当前状态，可能重复显示</p>
                </div>
                
                <div class="solution">
                    <h4>✅ 修复后方案</h4>
                    <div class="code-sample">// 新版添加重复检查
showWhatHappenedButton() {
  // 防止重复显示
  if (!this.actionButton.classList.contains('hidden')) return;
  
  this.actionButton.classList.remove('hidden');
  this.actionButton.classList.add('show');
  // 立即隐藏按钮防止重复点击
}</div>
                    <p>特点：检查当前状态，防止重复显示和绑定</p>
                </div>
            </div>
            
            <h4>修复要点：</h4>
            <ul class="feature-list">
                <li>🛡️ <strong>重复检查</strong>：检查按钮hidden状态，避免重复显示</li>
                <li>⚡ <strong>立即隐藏</strong>：点击后立即隐藏按钮，防止重复点击</li>
                <li>🔒 <strong>事件保护</strong>：添加choiceMade状态检查，防止重复选择</li>
            </ul>
        </div>
        
        <!-- 问题2：选择按钮重复 -->
        <div class="fix-section">
            <h3 class="section-title">🎯 问题2：选择按钮重复修复</h3>
            
            <div class="problem-solution">
                <div class="problem">
                    <h4>❌ 修复前问题</h4>
                    <div class="code-sample">// 旧版没有保护机制
showChoiceButtons() {
  this.choiceContainer.classList.add('show');
  // 可能多次绑定事件
  choiceButtons.forEach(button => {
    button.onclick = () => this.makeChoice(choice);
  });
}</div>
                    <p>问题：没有状态检查，可能重复显示和绑定事件</p>
                </div>
                
                <div class="solution">
                    <h4>✅ 修复后方案</h4>
                    <div class="code-sample">// 新版添加多重保护
showChoiceButtons() {
  // 防止重复显示
  if (this.choiceContainer.classList.contains('show')) return;
  
  choiceButtons.forEach(button => {
    button.onclick = () => {
      if (!this.choiceMade) {
        this.hideChoiceContainer(); // 立即隐藏
        this.makeChoice(choice);
      }
    };
  });
}</div>
                    <p>特点：多重保护机制，确保只执行一次</p>
                </div>
            </div>
        </div>
        
        <!-- 新功能：战斗胜利界面 -->
        <div class="fix-section">
            <h3 class="section-title">🏆 新功能：战斗胜利界面</h3>
            
            <div class="solution" style="grid-column: 1 / -1;">
                <h4>✨ 华丽的胜利界面</h4>
                <div class="code-sample">showVictoryMessage() {
  // 创建华丽的胜利界面
  const message = document.createElement('div');
  message.innerHTML = `
    ⚔️ 战斗胜利！ ⚔️
    英雄救美成功
    
    你勇敢地挺身而出，保护了无辜的男孩
    贵族少年在你的威慑下落荒而逃
    正义得到了伸张，善良得到了守护
    
    🏆 获得属性提升：武德 +5
    
    [继续冒险 ➡️]
  `;
}</div>
            </div>
            
            <h4>胜利界面特色：</h4>
            <ul class="feature-list">
                <li>🎨 <strong>视觉设计</strong>：金色边框，渐变背景，发光效果</li>
                <li>📝 <strong>故事内容</strong>：详细描述战斗过程和正义主题</li>
                <li>🏆 <strong>属性奖励</strong>：明确显示武德+5的属性提升</li>
                <li>✨ <strong>动画效果</strong>：渐显动画，轻微缩放效果</li>
                <li>🎮 <strong>交互设计</strong>：美观的继续按钮，悬停效果</li>
            </ul>
        </div>
        
        <!-- 技术细节 -->
        <div class="fix-section">
            <h3 class="section-title">⚙️ 技术实现细节</h3>
            
            <h4>防重复机制：</h4>
            <div class="code-sample">// 1. 按钮状态检查
if (!this.actionButton.classList.contains('hidden')) return;

// 2. 选择容器状态检查  
if (this.choiceContainer.classList.contains('show')) return;

// 3. 选择状态保护
if (!this.choiceMade) { /* 执行选择 */ }

// 4. 立即隐藏UI
this.hideActionButton();
this.hideChoiceContainer();</div>
            
            <h4>完整流程控制：</h4>
            <div class="code-sample">阶段1视频结束 → showWhatHappenedButton() → 检查hidden状态 → 显示按钮
点击按钮 → 立即隐藏 → startPhase2()
阶段2视频结束 → showChoiceButtons() → 检查show状态 → 显示选择
点击选择 → 立即隐藏 → makeChoice() → 检查choiceMade
播放结果 → 震撼转场 → 最终视频 → showVictoryMessage()</div>
        </div>
        
        <!-- 测试链接 -->
        <div style="text-align: center; margin-top: 30px;">
            <button class="control-button" onclick="window.open('scene5-new.html', '_blank')">
                🎬 测试镜头5（修复版）
            </button>
            <button class="control-button" onclick="window.open('index-story.html', '_blank')">
                🎭 测试完整故事流程
            </button>
            <button class="control-button" onclick="simulateVictory()">
                🏆 预览战斗胜利界面
            </button>
        </div>
    </div>
    
    <script>
        function simulateVictory() {
            // 创建模拟的战斗胜利界面
            const message = document.createElement('div');
            message.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, rgba(0, 0, 0, 0.95) 0%, rgba(20, 40, 20, 0.95) 100%);
                color: #FFD700;
                padding: 50px;
                border-radius: 20px;
                border: 3px solid #FFD700;
                text-align: center;
                z-index: 99999;
                font-size: 18px;
                max-width: 600px;
                min-width: 500px;
                box-shadow: 
                    0 0 50px rgba(255, 215, 0, 0.5),
                    inset 0 1px 0 rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(15px);
                opacity: 0;
                animation: victoryFadeIn 0.8s ease-out forwards;
            `;
            
            message.innerHTML = `
                <div style="font-size: 36px; margin-bottom: 20px; color: #90EE90;">⚔️ 战斗胜利！ ⚔️</div>
                <div style="font-size: 24px; margin-bottom: 25px; color: #FFD700;">英雄救美成功</div>
                <div style="margin-bottom: 20px; color: #FFFFFF; line-height: 1.6;">
                    <p>你勇敢地挺身而出，保护了无辜的男孩</p>
                    <p>贵族少年在你的威慑下落荒而逃</p>
                    <p>正义得到了伸张，善良得到了守护</p>
                </div>
                <div style="margin-bottom: 30px; color: #90EE90; font-size: 20px; font-weight: bold;">
                    🏆 获得属性提升：武德 +5
                </div>
                <button onclick="this.parentElement.remove()" 
                        style="padding: 15px 30px; background: linear-gradient(45deg, #FFD700, #FFA500); 
                               color: #000; border: none; border-radius: 12px; cursor: pointer; 
                               font-size: 18px; font-weight: bold; box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
                               transition: all 0.3s ease;">
                    继续冒险 ➡️
                </button>
            `;
            
            document.body.appendChild(message);
        }
        
        // 添加动画样式
        const style = document.createElement('style');
        style.textContent = `
            @keyframes victoryFadeIn {
                0% {
                    opacity: 0;
                    transform: translate(-50%, -50%) scale(0.8);
                }
                60% {
                    opacity: 1;
                    transform: translate(-50%, -50%) scale(1.05);
                }
                100% {
                    opacity: 1;
                    transform: translate(-50%, -50%) scale(1);
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html> 