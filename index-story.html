<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ²‰æµ¸å¼åŠ¨æ€äº’åŠ¨ç»˜æœ¬ - å®Œæ•´æ•…äº‹</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            overflow: hidden;
            font-family: 'Microsoft YaHei', sans-serif;
            cursor: crosshair;
        }
        
        /* é•œå¤´å®¹å™¨ */
        .scene-frame {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
        }
        
        .scene-frame.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        .scene-frame iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        /* è½¬åœºæ•ˆæœ */
        .transition-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            z-index: 99999;
            opacity: 0;
            transition: opacity 0.8s ease-in-out;
            pointer-events: none;
        }
        
        .transition-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        /* é•œå¤´æ ‡é¢˜æ˜¾ç¤º */
        .scene-title {
            display: none !important; /* éšè—"é•œå¤´X"æ–‡å­—æç¤º */
            position: fixed;
            top: 30px;
            left: 30px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            z-index: 10000;
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 15px;
            border-radius: 20px;
            backdrop-filter: blur(5px);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .scene-title.show {
            opacity: 1;
        }
        
        /* æ§åˆ¶é¢æ¿ */
        .story-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 12px;
            z-index: 10000;
            min-width: 200px;
            border: 1px solid #333;
        }
        
        .control-button {
            display: block;
            width: 100%;
            margin: 5px 0;
            padding: 8px;
            background: #333;
            color: white;
            border: 1px solid #666;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
            transition: background 0.3s;
        }
        
        .control-button:hover {
            background: #555;
        }
        
        .control-button:disabled {
            background: #222;
            color: #666;
            cursor: not-allowed;
        }
        
        .status-info {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #666;
            font-size: 10px;
            opacity: 0.8;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading-indicator {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .loading-indicator.show {
            opacity: 1;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        .loading-indicator.show::after {
            content: '...';
            animation: pulse 1.5s infinite;
        }
        
        #console-toggle-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            border: 2px solid #ffcc00;
            color: #ffcc00;
            padding: 10px 12px;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            z-index: 99999;
            transition: background 0.3s;
        }
        #console-toggle-btn:hover {
            background: rgba(255, 204, 0, 0.9);
            color: #000;
        }
    </style>
</head>
<body>
    <!-- è½¬åœºè¦†ç›–å±‚ -->
    <div class="transition-overlay" id="transition-overlay"></div>
    
    <!-- é•œå¤´æ ‡é¢˜ -->
    <div class="scene-title" id="scene-title">é•œå¤´1ï¼šè¡£æŸœè§†è§’</div>
    
    <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
    <div class="loading-indicator" id="loading-indicator">åŠ è½½ä¸­</div>
    
    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="story-controls">
        <h4 style="margin: 0 0 10px 0; color: #ffcc00;">å®Œæ•´æ•…äº‹æ§åˆ¶å°</h4>
        
        <button class="control-button" onclick="goToScene(1)">é•œå¤´1ï¼šè¡£æŸœè§†è§’</button>
        <button class="control-button" onclick="goToScene(2)">é•œå¤´2ï¼šç‰ä½©è§‰é†’</button>
        <button class="control-button" onclick="goToScene(3)">é•œå¤´3ï¼šæ—¶ç©ºç©¿è¶Š</button>
        <button class="control-button" onclick="goToScene(4)">é•œå¤´4ï¼šè§‰é†’æ—…ç¨‹</button>
        <button class="control-button" onclick="launchScene5()">é•œå¤´5ï¼šè‹±é›„æ•‘ç¾</button>
        <button class="control-button" onclick="launchScene6()">é•œå¤´6ï¼šé¦–æˆ˜å‘Šæ·</button>
        <button class="control-button" onclick="launchScene7()">é•œå¤´7ï¼šæœªçŸ¥æ—…ç¨‹</button>
        <button class="control-button" onclick="nextScene()" id="next-btn">ä¸‹ä¸€é•œå¤´</button>
        <button class="control-button" onclick="prevScene()" id="prev-btn">ä¸Šä¸€é•œå¤´</button>
        <button class="control-button" onclick="restartStory()">é‡æ–°å¼€å§‹</button>
        <button class="control-button" onclick="toggleFullscreen()">å…¨å±/çª—å£</button>
        
        <div class="status-info">
            <div>å½“å‰é•œå¤´: <span id="current-scene">1</span>/5</div>
            <div>çŠ¶æ€: <span id="story-status">æ’­æ”¾ä¸­</span></div>
            <div>è¿›åº¦: <span id="progress">0%</span></div>
        </div>
        
        <div style="margin-top: 10px; font-size: 10px; opacity: 0.6;">
            <div>å¿«æ·é”®:</div>
            <div>â†’ ä¸‹ä¸€é•œå¤´ | â† ä¸Šä¸€é•œå¤´</div>
            <div>R é‡æ–°å¼€å§‹ | F å…¨å±</div>
            <div>1/2/3/4/5 ç›´æ¥è·³è½¬é•œå¤´</div>
        </div>
    </div>
    
    <!-- é•œå¤´1å®¹å™¨ -->
    <div class="scene-frame active" id="scene1-frame">
        <iframe src="scene1.html" id="scene1-iframe"></iframe>
    </div>
    
    <!-- é•œå¤´2å®¹å™¨ -->
    <div class="scene-frame" id="scene2-frame">
        <iframe src="simple-test-scene2.html" id="scene2-iframe"></iframe>
    </div>
    
    <!-- é•œå¤´3å®¹å™¨ -->
    <div class="scene-frame" id="scene3-frame">
        <iframe data-src="scene3-time-vortex.html" id="scene3-iframe"></iframe>
    </div>
    
    <!-- é•œå¤´4å®¹å™¨ -->
    <div class="scene-frame" id="scene4-frame">
        <iframe data-src="scene4-new-awakening.html" id="scene4-iframe"></iframe>
    </div>
    
    <!-- é•œå¤´5å®¹å™¨ -->
    <div class="scene-frame" id="scene5-frame">
        <iframe data-src="scene5-new.html" id="scene5-iframe"></iframe>
    </div>

    <script>
        // æ•…äº‹ç®¡ç†å™¨
        class StoryManager {
            constructor() {
                this.currentScene = 1;
                this.totalScenes = 5;
                this.isTransitioning = false;
                this.scene1SwitchDetected = false; // é˜²æ­¢é‡å¤æ£€æµ‹é•œå¤´1åˆ‡æ¢
                this.scenes = {
                    1: {
                        name: 'é•œå¤´1ï¼šè¡£æŸœè§†è§’',
                        file: 'scene1.html',
                        iframe: 'scene1-iframe',
                        frame: 'scene1-frame'
                    },
                    2: {
                        name: 'é•œå¤´2ï¼šç‰ä½©è§‰é†’',
                        file: 'simple-test-scene2.html',
                        iframe: 'scene2-iframe',
                        frame: 'scene2-frame'
                    },
                    3: {
                        name: 'é•œå¤´3ï¼šæ—¶ç©ºç©¿è¶Š',
                        file: 'scene3-time-vortex.html',
                        iframe: 'scene3-iframe',
                        frame: 'scene3-frame'
                    },
                    4: {
                        name: 'é•œå¤´4ï¼šè§‰é†’æ—…ç¨‹',
                        file: 'scene4-new-awakening.html',
                        iframe: 'scene4-iframe',
                        frame: 'scene4-frame'
                    },
                    5: {
                        name: 'é•œå¤´5ï¼šè‹±é›„æ•‘ç¾',
                        file: 'scene5-new.html',
                        iframe: 'scene5-iframe',
                        frame: 'scene5-frame'
                    }
                };
                
                this.init();
            }
            
            init() {
                console.log('ğŸ¬ æ•…äº‹ç®¡ç†å™¨åˆå§‹åŒ–');
                this.updateUI();
                this.setupEventListeners();
                this.setupSceneListeners();
                
                // åˆå§‹åŒ–ç¬¬ä¸€ä¸ªé•œå¤´
                this.showLoadingIndicator('æ­£åœ¨åŠ è½½é•œå¤´1...');
                this.hideLoadingIndicator(2000);
            }
            
            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            setupEventListeners() {
                // é”®ç›˜å¿«æ·é”®
                document.addEventListener('keydown', (e) => {
                    if (this.isTransitioning) return;
                    
                    switch(e.key) {
                        case 'ArrowRight':
                            this.nextScene();
                            break;
                        case 'ArrowLeft':
                            this.prevScene();
                            break;
                        case 'r':
                        case 'R':
                            this.restartStory();
                            break;
                        case 'f':
                        case 'F':
                            this.toggleFullscreen();
                            break;
                        case '1':
                            this.goToScene(1);
                            break;
                        case '2':
                            this.goToScene(2);
                            break;
                        case '3':
                            this.goToScene(3);
                            break;
                        case '4':
                            this.goToScene(4);
                            break;
                        case '5':
                            this.goToScene(5);
                            break;
                    }
                });
                
                // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        this.pauseCurrentScene();
                    } else {
                        this.resumeCurrentScene();
                    }
                });
            }
            
            // è®¾ç½®é•œå¤´é—´é€šä¿¡
            setupSceneListeners() {
                // ç›‘å¬é•œå¤´1å®Œæˆäº‹ä»¶
                window.addEventListener('message', (event) => {
                    if (event.data.type === 'scene1-complete') {
                        console.log('âœ… æ”¶åˆ°é•œå¤´1å®Œæˆä¿¡å·');
                        // ç«‹å³è½¬åœºï¼Œä¸ç­‰å¾…ï¼Œç¡®ä¿ç”¨æˆ·èƒ½çœ‹åˆ°é•œå¤´2çš„N001
                        this.transitionToScene(2);
                    } else if (event.data.type === 'scene2-complete') {
                        console.log('âœ… æ”¶åˆ°é•œå¤´2å®Œæˆä¿¡å·');
                        this.transitionToScene(3);
                    } else if (event.data.type === 'scene3-complete') {
                        console.log('âœ… æ”¶åˆ°é•œå¤´3å®Œæˆä¿¡å·');
                        this.transitionToScene(4);
                    } else if (event.data.type === 'scene4-complete') {
                        console.log('âœ… æ”¶åˆ°é•œå¤´4å®Œæˆä¿¡å·');
                        this.transitionToScene(5);
                    } else if (event.data.type === 'scene5-complete') {
                        console.log('âœ… æ”¶åˆ°é•œå¤´5å®Œæˆä¿¡å·');
                        // é•œå¤´5å†…éƒ¨å°†ç»§ç»­æ’­æ”¾é•œå¤´6ï¼Œæ— éœ€è½¬åœº
                        this.updateStatus('é•œå¤´6æ’­æ”¾ä¸­');
                    } else if (event.data.type === 'scene6-complete') {
                        console.log('âœ… æ”¶åˆ°é•œå¤´6å®Œæˆä¿¡å·');
                        this.updateStatus('é•œå¤´7å‡†å¤‡ä¸­');
                    } else if (event.data.type === 'scene7-start') {
                        console.log('â–¶ï¸ é•œå¤´7å¼€å§‹æ’­æ”¾');
                        this.updateStatus('é•œå¤´7æ’­æ”¾ä¸­');
                    } else if (event.data.type === 'scene7-complete') {
                        console.log('âœ… æ”¶åˆ°é•œå¤´7å®Œæˆä¿¡å·');
                        this.updateStatus('æ•…äº‹å®Œæˆ');
                        this.showStoryComplete();
                    } else if (event.data.type === 'request-audio-status') {
                        // é•œå¤´2è¯·æ±‚éŸ³é¢‘çŠ¶æ€
                        console.log('ğŸµ æ”¶åˆ°éŸ³é¢‘çŠ¶æ€è¯·æ±‚');
                        this.sendAudioStatus(event.source);
                    } else if (event.data.type === 'audio-unlocked-from-scene1') {
                        // é•œå¤´1é€šçŸ¥éŸ³é¢‘å·²è§£é”
                        console.log('ğŸµ æ”¶åˆ°é•œå¤´1éŸ³é¢‘è§£é”é€šçŸ¥');
                        this.audioUnlocked = true;
                        this.broadcastAudioUnlocked();
                    }
                });
                
                // éŸ³é¢‘è§£é”çŠ¶æ€
                this.audioUnlocked = false;
                
                // å®šæœŸæ£€æŸ¥iframeåŠ è½½çŠ¶æ€
                this.checkIframeStatus();
            }
            
            // å‘é€éŸ³é¢‘çŠ¶æ€ç»™è¯·æ±‚çš„iframe
            sendAudioStatus(targetWindow) {
                if (this.audioUnlocked) {
                    console.log('ğŸµ å‘é€éŸ³é¢‘å·²è§£é”çŠ¶æ€');
                    targetWindow.postMessage({
                        type: 'audio-unlocked'
                    }, '*');
                } else {
                    console.log('ğŸµ éŸ³é¢‘å°šæœªè§£é”ï¼Œç­‰å¾…é•œå¤´1è§£é”');
                }
            }
            
            // å¹¿æ’­éŸ³é¢‘è§£é”çŠ¶æ€ç»™æ‰€æœ‰iframe
            broadcastAudioUnlocked() {
                console.log('ğŸµ å¹¿æ’­éŸ³é¢‘è§£é”çŠ¶æ€ç»™æ‰€æœ‰é•œå¤´');
                Object.keys(this.scenes).forEach(sceneNum => {
                    const iframe = document.getElementById(this.scenes[sceneNum].iframe);
                    if (iframe && iframe.contentWindow) {
                        iframe.contentWindow.postMessage({
                            type: 'audio-unlocked'
                        }, '*');
                    }
                });
            }
            
            // æ£€æŸ¥iframeåŠ è½½çŠ¶æ€
            checkIframeStatus() {
                setInterval(() => {
                    try {
                        const scene1Iframe = document.getElementById('scene1-iframe');
                        const scene2Iframe = document.getElementById('scene2-iframe');
                        
                        if (scene1Iframe && scene1Iframe.contentWindow) {
                            // æ£€æŸ¥é•œå¤´1æ˜¯å¦æœ‰storybookå®ä¾‹
                            const storybook = scene1Iframe.contentWindow.storybook;
                            if (storybook && storybook.currentScene === 1.5 && !this.scene1SwitchDetected) {
                                // é•œå¤´1å‡†å¤‡åˆ‡æ¢åˆ°ä¸‹ä¸€åœºæ™¯
                                console.log('ğŸ¬ æ£€æµ‹åˆ°é•œå¤´1å‡†å¤‡åˆ‡æ¢');
                                this.scene1SwitchDetected = true; // é˜²æ­¢é‡å¤æ£€æµ‹
                            }
                        }
                    } catch (e) {
                        // è·¨åŸŸé™åˆ¶ï¼Œå¿½ç•¥é”™è¯¯
                    }
                }, 2000);
            }
            
            // åˆ‡æ¢åˆ°æŒ‡å®šé•œå¤´
            goToScene(sceneNumber) {
                if (sceneNumber === this.currentScene || this.isTransitioning) return;
                if (sceneNumber < 1 || sceneNumber > this.totalScenes) return;
                
                this.transitionToScene(sceneNumber);
            }
            
            // ä¸‹ä¸€é•œå¤´
            nextScene() {
                if (this.currentScene < this.totalScenes) {
                    this.goToScene(this.currentScene + 1);
                }
            }
            
            // ä¸Šä¸€é•œå¤´
            prevScene() {
                if (this.currentScene > 1) {
                    this.goToScene(this.currentScene - 1);
                }
            }
            
            // åœæ­¢æ‰€æœ‰é•œå¤´çš„éŸ³é¢‘
            stopAllAudio() {
                console.log('ğŸ”‡ åœæ­¢æ‰€æœ‰é•œå¤´çš„éŸ³é¢‘');
                
                // åœæ­¢æ‰€æœ‰iframeä¸­çš„éŸ³é¢‘
                Object.keys(this.scenes).forEach(sceneNum => {
                    const iframe = document.getElementById(this.scenes[sceneNum].iframe);
                    console.log(`ğŸ” æ£€æŸ¥é•œå¤´${sceneNum}çš„iframe:`, iframe ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
                    
                    if (iframe) {
                        console.log(`ğŸ” é•œå¤´${sceneNum}çš„contentWindow:`, iframe.contentWindow ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
                        
                        if (iframe.contentWindow) {
                            try {
                                // å‘é€åœæ­¢éŸ³é¢‘ä¿¡å·
                                console.log(`ğŸ“¤ å‘é•œå¤´${sceneNum}å‘é€åœæ­¢éŸ³é¢‘ä¿¡å·`);
                                iframe.contentWindow.postMessage({type: 'stop-all-audio'}, '*');
                            } catch (e) {
                                console.warn(`âŒ æ— æ³•å‘é•œå¤´${sceneNum}å‘é€åœæ­¢éŸ³é¢‘ä¿¡å·:`, e);
                            }
                        } else {
                            console.warn(`âš ï¸ é•œå¤´${sceneNum}çš„contentWindowä¸å¯ç”¨`);
                        }
                    } else {
                        console.warn(`âš ï¸ æœªæ‰¾åˆ°é•œå¤´${sceneNum}çš„iframeå…ƒç´ `);
                    }
                });
            }
            
            // è½¬åœºåˆ°æŒ‡å®šé•œå¤´
            transitionToScene(sceneNumber) {
                if (this.isTransitioning) return;
                
                console.log(`ğŸ¬ å¼€å§‹è½¬åœº: é•œå¤´${this.currentScene} â†’ é•œå¤´${sceneNumber}`);
                
                // åœæ­¢æ‰€æœ‰é•œå¤´çš„éŸ³é¢‘
                this.stopAllAudio();
                
                this.isTransitioning = true;
                this.updateStatus('è½¬åœºä¸­...');
                
                const overlay = document.getElementById('transition-overlay');
                const sceneTitle = document.getElementById('scene-title');
                
                // æ˜¾ç¤ºè½¬åœºæ•ˆæœ
                overlay.classList.add('active');
                sceneTitle.classList.remove('show');
                
                setTimeout(() => {
                    // å‘é€æ¸…ç†æŒ‡ä»¤åˆ°å½“å‰iframe
                    const currentIframeWin=document.getElementById(this.scenes[this.currentScene].iframe)?.contentWindow;
                    if(currentIframeWin){
                        currentIframeWin.postMessage({type:'cleanup-ui'}, '*');
                    }

                    // éšè—å½“å‰é•œå¤´
                    const currentFrame = document.getElementById(this.scenes[this.currentScene].frame);
                    currentFrame.classList.remove('active');
                    
                    // æ˜¾ç¤ºç›®æ ‡é•œå¤´
                    const targetFrame = document.getElementById(this.scenes[sceneNumber].frame);
                    targetFrame.classList.add('active');

                    // ğŸ‘‰ é€šç”¨æ‡’åŠ è½½ï¼šè‹¥ç›®æ ‡ iframe å°šæœªåŠ è½½ï¼Œè‡ªåŠ¨èµ‹å€¼ src
                    const targetIframe = document.getElementById(this.scenes[sceneNumber].iframe);
                    if (targetIframe && !targetIframe.getAttribute('src')) {
                        console.log(`ğŸ”„ åŠ è½½é•œå¤´${sceneNumber}é¡µé¢`);
                        if (targetIframe.dataset.src) {
                            targetIframe.src = targetIframe.dataset.src;
                        } else if (this.scenes[sceneNumber].file) {
                            targetIframe.src = this.scenes[sceneNumber].file;
                        }
                    }
                    
                    // æ›´æ–°å½“å‰é•œå¤´
                    this.currentScene = sceneNumber;
                    this.updateUI();
                    
                    // å¦‚æœåˆ‡æ¢åˆ°é•œå¤´3ï¼Œç¡®ä¿åŠ è½½å®Œæˆåå‘é€å¯åŠ¨ä¿¡å·
                    if (sceneNumber === 3) {
                        const scene3Iframe = document.getElementById('scene3-iframe');
                        const sendStartMsg = () => {
                            console.log('ğŸ“¤ å‘é€é•œå¤´3å¯åŠ¨ä¿¡å·');
                            scene3Iframe.contentWindow.postMessage({ type: 'scene3-start' }, '*');
                        };
                        if (!scene3Iframe.getAttribute('src')) {
                            // è¿˜æœªè®¾ç½® srcï¼Œä¸Šé¢æ‡’åŠ è½½é€»è¾‘å·²è®¾ç½®ï¼Œæ­¤å¤„ç­‰å¾… onload
                            scene3Iframe.onload = () => setTimeout(sendStartMsg, 500);
                        } else if (scene3Iframe.contentWindow && scene3Iframe.contentWindow.document.readyState === 'complete') {
                            // å·²ç»åŠ è½½å®Œæˆ
                            setTimeout(sendStartMsg, 200);
                        } else {
                            // å·²è®¾ç½® src ä½†å¯èƒ½æœªåŠ è½½å®Œæˆ
                            scene3Iframe.onload = () => setTimeout(sendStartMsg, 200);
                        }
                    }
                    
                    // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
                    this.showLoadingIndicator(`æ­£åœ¨åŠ è½½${this.scenes[sceneNumber].name}...`);
                    
                    setTimeout(() => {
                        // éšè—è½¬åœºæ•ˆæœ
                        overlay.classList.remove('active');
                        sceneTitle.classList.add('show');
                        this.hideLoadingIndicator();
                        
                        this.isTransitioning = false;
                        this.updateStatus('æ’­æ”¾ä¸­');
                        
                        console.log(`âœ… è½¬åœºå®Œæˆ: ç°åœ¨æ˜¯${this.scenes[sceneNumber].name}`);
                    }, 100);  // è¿›ä¸€æ­¥å‡å°‘åˆ°100ms
                }, 50);   // è¿›ä¸€æ­¥å‡å°‘åˆ°50ms
            }
            
            // é‡æ–°å¼€å§‹æ•…äº‹
            restartStory() {
                console.log('ğŸ”„ é‡æ–°å¼€å§‹æ•…äº‹');
                
                // åˆ·æ–°æ‰€æœ‰iframe
                Object.keys(this.scenes).forEach(sceneNum => {
                    const iframe = document.getElementById(this.scenes[sceneNum].iframe);
                    if (iframe) {
                        iframe.src = iframe.src; // é‡æ–°åŠ è½½
                    }
                });
                
                // å›åˆ°ç¬¬ä¸€é•œå¤´
                if (this.currentScene !== 1) {
                    this.goToScene(1);
                } else {
                    this.updateStatus('å·²é‡ç½®');
                }
            }
            
            // æš‚åœå½“å‰é•œå¤´
            pauseCurrentScene() {
                try {
                    const currentIframe = document.getElementById(this.scenes[this.currentScene].iframe);
                    if (currentIframe && currentIframe.contentWindow) {
                        // å‘é€æš‚åœä¿¡å·
                        currentIframe.contentWindow.postMessage({type: 'pause'}, '*');
                    }
                } catch (e) {
                    console.warn('æ— æ³•æš‚åœå½“å‰é•œå¤´:', e);
                }
            }
            
            // æ¢å¤å½“å‰é•œå¤´
            resumeCurrentScene() {
                try {
                    const currentIframe = document.getElementById(this.scenes[this.currentScene].iframe);
                    if (currentIframe && currentIframe.contentWindow) {
                        // å‘é€æ¢å¤ä¿¡å·
                        currentIframe.contentWindow.postMessage({type: 'resume'}, '*');
                    }
                } catch (e) {
                    console.warn('æ— æ³•æ¢å¤å½“å‰é•œå¤´:', e);
                }
            }
            
            // æ˜¾ç¤ºæ•…äº‹å®Œæˆ
            showStoryComplete() {
                const overlay = document.getElementById('transition-overlay');
                overlay.innerHTML = `
                    <div style="
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        text-align: center;
                        color: white;
                        font-size: 24px;
                    ">
                        <h1 style="margin-bottom: 20px; color: #ffcc00;">ğŸŠ æ•…äº‹å®Œæˆ ğŸŠ</h1>
                        <p style="margin-bottom: 30px; font-size: 18px;">æ„Ÿè°¢ä½“éªŒæ²‰æµ¸å¼åŠ¨æ€äº’åŠ¨ç»˜æœ¬</p>
                        <button onclick="storyManager.restartStory()" style="
                            padding: 15px 30px;
                            font-size: 16px;
                            background: #333;
                            color: white;
                            border: 2px solid #ffcc00;
                            border-radius: 25px;
                            cursor: pointer;
                            transition: all 0.3s;
                        " onmouseover="this.style.background='#555'" onmouseout="this.style.background='#333'">
                            é‡æ–°ä½“éªŒ
                        </button>
                    </div>
                `;
                overlay.classList.add('active');
            }
            
            // æ›´æ–°UIæ˜¾ç¤º
            updateUI() {
                document.getElementById('current-scene').textContent = this.currentScene;
                document.getElementById('scene-title').textContent = this.scenes[this.currentScene].name;
                document.getElementById('progress').textContent = Math.round((this.currentScene / this.totalScenes) * 100) + '%';
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.getElementById('prev-btn').disabled = this.currentScene === 1;
                document.getElementById('next-btn').disabled = this.currentScene === this.totalScenes;
            }
            
            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            updateStatus(status) {
                document.getElementById('story-status').textContent = status;
            }
            
            // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
            showLoadingIndicator(text) {
                const indicator = document.getElementById('loading-indicator');
                indicator.textContent = text;
                indicator.classList.add('show');
            }
            
            // éšè—åŠ è½½æŒ‡ç¤ºå™¨
            hideLoadingIndicator(delay = 0) {
                setTimeout(() => {
                    document.getElementById('loading-indicator').classList.remove('show');
                }, delay);
            }
            
            // å…¨å±åˆ‡æ¢
            toggleFullscreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(e => {
                        console.warn('æ— æ³•è¿›å…¥å…¨å±æ¨¡å¼:', e);
                    });
                } else {
                    document.exitFullscreen();
                }
            }
        }
        
        // å…¨å±€å‡½æ•°
        let storyManager;
        
        function goToScene(sceneNumber) {
            storyManager.goToScene(sceneNumber);
        }
        
        function nextScene() {
            storyManager.nextScene();
        }
        
        function prevScene() {
            storyManager.prevScene();
        }
        
        function restartStory() {
            storyManager.restartStory();
        }
        
        function toggleFullscreen() {
            storyManager.toggleFullscreen();
        }
        
        function launchScene6() {
            storyManager.goToScene(5);
            const iframe = document.getElementById('scene5-iframe');
            if (iframe && iframe.contentWindow) {
                iframe.contentWindow.postMessage({type: 'force-start-scene6'}, '*');
            }
        }
        
        function launchScene7() {
            storyManager.goToScene(5);
            const iframe = document.getElementById('scene5-iframe');
            if (iframe && iframe.contentWindow) {
                iframe.contentWindow.postMessage({type: 'force-start-scene7'}, '*');
            }
        }
        
        function launchScene5() {
            storyManager.transitionToScene(5);
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            storyManager = new StoryManager();
            console.log('ğŸ® å®Œæ•´æ•…äº‹ç³»ç»Ÿå·²å¯åŠ¨');
            
            // é¢„åŠ è½½å…³é”®è§†é¢‘èµ„æº
            if (window.videoPreloader) {
                const keyVideos = [
                    'é•œå¤´1/1/è§†çº¿æ¸…æ™°.mp4',
                    'é•œå¤´2/N001.mp4',
                    'é•œå¤´2/N002.mp4',
                    'é•œå¤´3/1/C03001.mp4'
                ];
                
                console.log('ğŸ¥ å¼€å§‹é¢„åŠ è½½å…³é”®è§†é¢‘èµ„æº...');
                window.videoPreloader.preloadVideoList(keyVideos, (loaded, total, progress) => {
                    console.log(`ğŸ¥ é¢„åŠ è½½è¿›åº¦: ${loaded}/${total} (${progress.toFixed(1)}%)`);
                });
            }
        });
        
        // é˜²æ­¢å³é”®å’Œé€‰æ‹©
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('selectstart', e => e.preventDefault());
    </script>

    <script>
        let consoleVisible = false; // å…¨å±€çŠ¶æ€

        function toggleConsolePanel(){
            const panel = document.querySelector('.story-controls');
            if (!panel) {
                console.error('âŒ æœªæ‰¾åˆ°æ§åˆ¶å°é¢æ¿å…ƒç´ ');
                return;
            }

            consoleVisible = !consoleVisible;
            if (consoleVisible) {
                panel.style.display = 'block';
                panel.style.visibility = 'visible';
                panel.style.opacity = '1';
                console.log('ğŸ® æ§åˆ¶å°æ˜¾ç¤º');
            } else {
                panel.style.display = 'none';
                console.log('ğŸ® æ§åˆ¶å°éšè—');
            }

            // å‘é€è°ƒè¯•ä¿¡æ¯ç»™æ‰€æœ‰iframe
            document.querySelectorAll('iframe').forEach(iframe=>{
                try{
                    iframe.contentWindow.postMessage({
                        type:'console-toggle-result',
                        visible: consoleVisible,
                        timestamp: Date.now()
                    },'*');
                }catch(e){}
            });
        }

        // ===== æ§åˆ¶å°åˆ‡æ¢ç»Ÿä¸€é˜²æŠ– =====
        let lastToggleTime = 0;
        const TOGGLE_DEBOUNCE = 1000; // æ¯«ç§’ï¼Œæ”¾å®½çª—å£é¿å…å¤šiframeé‡å¤è§¦å‘

        function safeToggleConsole() {
            const now = Date.now();
            if (now - lastToggleTime < TOGGLE_DEBOUNCE) {
                console.log('ğŸ›‘ é˜²æŠ–ï¼šå¿½ç•¥è¿‡å¿«çš„é‡å¤åˆ‡æ¢');
                return;
            }
            lastToggleTime = now;
            toggleConsolePanel();
        }

        // ç›‘å¬æ¥è‡ªå­iframeçš„åˆ‡æ¢è¯·æ±‚
        window.addEventListener('message', (e) => {
            if (e.data && e.data.type === 'toggle-console') {
                console.log('ğŸ® æ”¶åˆ°æ¥è‡ªiframeçš„æ§åˆ¶å°åˆ‡æ¢è¯·æ±‚, timestamp:', e.data.timestamp);
                safeToggleConsole();
            }
        });

        function handleConsoleToggle(e) {
            if (e._consoleToggleHandled) return;

            const isToggleKey = ['`', '~', 't', 'T'].includes(e.key) || 
                               ['Backquote', 'KeyT'].includes(e.code);

            if (isToggleKey) {
                e._consoleToggleHandled = true;
                e.preventDefault();
                e.stopPropagation();
                console.log('ğŸ® ä¸»é¡µé¢æ£€æµ‹åˆ°æ§åˆ¶å°åˆ‡æ¢é”®:', e.key, e.code);
                safeToggleConsole();
            }
        }
        
        // æ·»åŠ å¤šä¸ªäº‹ä»¶ç›‘å¬å™¨ï¼Œç¡®ä¿å¯é æ€§
        document.addEventListener('keydown', handleConsoleToggle, true); // æ•è·é˜¶æ®µ
        document.addEventListener('keydown', handleConsoleToggle, false); // å†’æ³¡é˜¶æ®µ
        
        // ä¸ºwindowä¹Ÿæ·»åŠ ç›‘å¬å™¨
        window.addEventListener('keydown', handleConsoleToggle);

        // é¡µé¢åŠ è½½ååˆå§‹åŒ–æ§åˆ¶å°ä¸ºéšè—çŠ¶æ€
        document.addEventListener('DOMContentLoaded', () => {
            const panel = document.querySelector('.story-controls');
            if (panel) {
                panel.style.display = 'none';
                console.log('ğŸ® æ§åˆ¶å°åˆå§‹åŒ–ä¸ºéšè—çŠ¶æ€ï¼ŒæŒ‰ ~ æˆ– T é”®åˆ‡æ¢æ˜¾ç¤º');
            }
        });
    </script>
    
    <!-- å¼•å…¥è§†é¢‘é¢„åŠ è½½ç³»ç»Ÿ -->
    <script src="video-preloader.js"></script>

    <!-- åœ¨<body>æœ«å°¾å…³é—­å‰åŠ å…¥æŒ‰é’®å…ƒç´  -->
    <button id="console-toggle-btn" title="åˆ‡æ¢æ§åˆ¶å°">ğŸ› ï¸</button>

    <script>
        // æŒ‰é’®ç‚¹å‡»åˆ‡æ¢æ§åˆ¶å°
        document.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('console-toggle-btn');
            if (btn) {
                btn.addEventListener('click', () => {
                    safeToggleConsole();
                });
            }
        });
    </script>
</body>
</html> 